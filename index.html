<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการสินค้าคงคลัง</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Recharts -->
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f8fafc;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, Brush } = Recharts;

        // --- Icon Components (Replacements for Lucide-React) ---
        // Helper to create consistent SVG icons
        const CreateIcon = ({ d, className = "", ...props }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width="24" height="24" 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={`lucide ${className}`} 
                {...props}
            >
                {Array.isArray(d) ? d.map((path, i) => <path key={i} d={path} />) : <path d={d} />}
            </svg>
        );

        const Package = (props) => <CreateIcon d="M16.5 9.4 7.5 4.21 M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z M3.27 6.96 12 12.01l8.73-5.05 M12 22.08V12" {...props} />;
        const TrendingUp = (props) => <CreateIcon d={["M22 7L13.5 15.5L8.5 10.5L2 17", "M16 7H22V13"]} {...props} />;
        const TrendingDown = (props) => <CreateIcon d={["M22 17L13.5 8.5L8.5 13.5L2 7", "M16 17H22V11"]} {...props} />;
        const Calendar = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className} {...props}>
                <rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/>
            </svg>
        );
        const FileText = (props) => <CreateIcon d={["M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z", "M14 2v6h6", "M16 13H8", "M16 17H8", "M10 9H8"]} {...props} />;
        const User = (props) => <CreateIcon d={["M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"]} {...props} ><circle cx="12" cy="7" r="4"/></CreateIcon>;
        const Trash2 = (props) => <CreateIcon d={["M3 6h18", "M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6", "M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2", "M10 11v6", "M14 11v6"]} {...props} />;
        const X = (props) => <CreateIcon d={["M18 6 6 18", "M6 6l12 12"]} {...props} />;
        const FlaskConical = (props) => <CreateIcon d={["M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.533a1 1 0 0 0 .895 1.467h12.77a1 1 0 0 0 .894-1.467l-5.068-10.11a2 2 0 0 1-.212-.896V2", "M8.5 2h7", "M7 12h10"]} {...props} />;
        const History = (props) => <CreateIcon d={["M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8", "M3 3v5h5"]} {...props} />;
        const BarChart3 = (props) => <CreateIcon d={["M3 3v18h18", "M18 17V9", "M13 17V5", "M8 17v-3"]} {...props} />;
        const PlayCircle = (props) => <CreateIcon d={["M21 12a9 9 0 1 1-9-9 9 9 0 0 1 9 9Z", "M10 8l6 4-6 4V8Z"]} {...props} />;
        const AlertTriangle = (props) => <CreateIcon d={["M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z", "M12 9v4", "M12 17h.01"]} {...props} />;
        const LoaderCircle = (props) => <CreateIcon d={["M21 12a9 9 0 1 1-6.219-8.56"]} {...props} />;

        // --- Application Components ---

        // LoadingOverlay Component
        const LoadingOverlay = ({ message }) => (
            <div className="fixed inset-0 bg-black bg-opacity-60 flex flex-col items-center justify-center z-50">
                <div className="animate-spin text-white mb-4">
                    <LoaderCircle size={64} />
                </div>
                <p className="text-white text-xl font-semibold">{message}</p>
            </div>
        );

        // CustomAlertModal Component
        const CustomAlertModal = ({ title, message, onClose, onConfirm, showCancel = false, confirmText = 'ตกลง', cancelText = 'ยกเลิก', showPasswordInput = false, onPasswordChange, passwordValue, correctPassword }) => {
            const [error, setError] = useState('');

            const handlePasswordInputChange = (e) => {
                setError('');
                onPasswordChange(e.target.value);
            };

            const handleConfirmAction = () => {
                if (showPasswordInput) {
                    if (passwordValue === correctPassword) {
                        if (onConfirm) onConfirm();
                        onClose();
                    } else {
                        setError('รหัสผ่านผิด');
                        onPasswordChange('');
                    }
                } else {
                    if (onConfirm) onConfirm();
                    onClose();
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-2xl max-w-xs w-full p-8 shadow-2xl transform scale-100 transition-transform duration-300 ease-out relative">
                        <button onClick={onClose} className="absolute top-2 right-2 text-gray-400 hover:text-gray-600">
                            <X size={24} />
                        </button>
                        <div className="text-center">
                            <h3 className="text-2xl font-bold text-gray-800 mb-4">{title}</h3>
                            {message && <p className="text-gray-700 mb-6 whitespace-pre-wrap">{message}</p>}
                            
                            {showPasswordInput ? (
                                <>
                                    <div className="mb-6">
                                        <input
                                            type="password"
                                            placeholder="P A S S W O R D"
                                            autoFocus
                                            className={`w-full px-4 py-3 border-2 rounded-lg text-lg text-center ${error ? 'border-red-500' : 'border-gray-300'} focus:ring-2 focus:ring-blue-500 focus:border-blue-500`}
                                            value={passwordValue}
                                            onChange={handlePasswordInputChange}
                                            onKeyDown={(e) => {
                                                if (e.key === 'Enter') {
                                                    e.preventDefault();
                                                    handleConfirmAction();
                                                }
                                            }}
                                        />
                                        {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
                                    </div>
                                    <div className="flex gap-4">
                                        <button onClick={onClose} className="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-50 transition-colors">
                                            {cancelText}
                                        </button>
                                        <button onClick={handleConfirmAction} className="flex-1 px-4 py-3 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition-colors">
                                            {confirmText}
                                        </button>
                                    </div>
                                </>
                            ) : (
                                <div className="flex gap-4">
                                    {showCancel && (
                                        <button onClick={onClose} className="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-50 transition-colors">
                                            {cancelText}
                                        </button>
                                    )}
                                    <button onClick={handleConfirmAction} className={`flex-1 px-4 py-3 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition-colors ${showCancel ? '' : 'w-full'}`}>
                                        {confirmText}
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // Custom Tooltip for Charts
        const CustomTooltip = ({ active, payload, label, xAxisKey, year, month }) => {
            if (active && payload && payload.length) {
                let formattedLabel = label;
                if (xAxisKey === 'day' && year && month !== null && month >= 0) {
                    const date = new Date(year, month, label);
                    if (!isNaN(date)) {
                        formattedLabel = date.toLocaleDateString('th-TH', { weekday: 'long', day: 'numeric', month: 'short' });
                    }
                }

                return (
                    <div className="bg-white p-3 border border-gray-300 rounded-lg shadow-lg">
                        <p className="font-bold mb-2">{`${formattedLabel}`}</p>
                        {payload.map((entry, index) => (
                            <p key={`item-${index}`} style={{ color: entry.color }}>
                                {`${entry.name} : ${entry.value.toLocaleString()}`}
                            </p>
                        ))}
                    </div>
                );
            }
            return null;
        };

        // --- Main App Logic ---
        const App = () => {
            const GOOGLE_SHEETS_CONFIG = {
                webAppUrl: 'https://script.google.com/macros/s/AKfycbyfxWs81WEsrizNnTi82tZAOH_EHX1hKnvUoqsARpYch3TTjEqz5oepiol_vWQ4lK3G0g/exec',
                spreadsheetId: '18_aq1sA-m7W0ZPOvPs1RDtEoZUIY-9PabPghKo6ZfjE'
            };

            const formatDateForInput = (date) => {
                const d = new Date(date);
                let month = '' + (d.getMonth() + 1);
                let day = '' + d.getDate();
                const year = d.getFullYear();
                if (month.length < 2) month = '0' + month;
                if (day.length < 2) day = '0' + day;
                return [year, month, day].join('-');
            };
            
            const parseCSDateString = (dateInput) => {
                if (!dateInput) return new Date('invalid');
                if (dateInput instanceof Date) return dateInput;

                if (typeof dateInput === 'string') {
                    const parts = dateInput.split(', ');
                    if (parts.length !== 2) return new Date('invalid');

                    const dateParts = parts[0].split('/');
                    const timeParts = parts[1].split(':');

                    if (dateParts.length !== 3 || (timeParts.length !== 2 && timeParts.length !== 3)) return new Date('invalid');
                    
                    const day = parseInt(dateParts[0], 10);
                    const month = parseInt(dateParts[1], 10) - 1; 
                    const year = parseInt(dateParts[2], 10);
                    const hours = parseInt(timeParts[0], 10);
                    const minutes = parseInt(timeParts[1], 10);
                    const seconds = timeParts.length === 3 ? parseInt(timeParts[2], 10) : 0;

                    const date = new Date(year, month, day, hours, minutes, seconds);
                    if (isNaN(date.getTime())) {
                        return new Date('invalid');
                    }
                    return date;
                }
                return new Date('invalid');
            };

            const formatDateTimeForDisplay = (date) => {
                if (!date || !(date instanceof Date) || isNaN(date.getTime())) return '';
                return date.toLocaleString('en-GB', {
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour: '2-digit', minute: '2-digit', second: '2-digit',
                    hour12: false
                }).replace(',', '');
            };

            const currentYear = new Date().getFullYear();
            const currentMonth = (new Date().getMonth() + 1).toString();
            const todayFormatted = formatDateForInput(new Date());

            const [records, setRecords] = useState([]);
            const [productionRecords, setProductionRecords] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [loadingMessage, setLoadingMessage] = useState('');
            const [connectionStatus, setConnectionStatus] = useState('disconnected');

            const [formData, setFormData] = useState({ name: '', status: '', quantity: '', images: [], selectedDate: todayFormatted });
            const [todayProduced, setTodayProduced] = useState('');

            const [currentPage, setCurrentPage] = useState('inventory');
            const [selectedRecord, setSelectedRecord] = useState(null);
            const [showModal, setShowModal] = useState(false);
            const [showConfirmModal, setShowConfirmModal] = useState(false);
            const [debounceTimer, setDebounceTimer] = useState(null);
            const [currentImagePreview, setCurrentImagePreview] = useState(null);

            const [showAlertModal, setShowAlertModal] = useState(false);
            const [alertTitle, setAlertTitle] = useState('');
            const [alertMessage, setAlertMessage] = useState('');
            const [alertOnConfirm, setAlertOnConfirm] = useState(null);
            const [alertShowCancel, setAlertShowCancel] = useState(false);
            const [alertConfirmText, setAlertConfirmText] = useState('ตกลง');
            const [alertCancelText, setAlertCancelText] = useState('ยกเลิก');
            const [alertPasswordValue, setAlertPasswordValue] = useState('');
            const [alertShowPasswordInput, setAlertShowPasswordInput] = useState(false);
            const [alertCorrectPassword, setAlertCorrectPassword] = useState('');

            const [filterYear, setFilterYear] = useState(currentYear.toString()); 
            const [filterMonth, setFilterMonth] = useState(currentMonth); 
            const [filterStatus, setFilterStatus] = useState('');

            const [productionFilterYear, setProductionFilterYear] = useState(currentYear.toString());
            const [productionFilterMonth, setProductionFilterMonth] = useState(currentMonth);

            const [chartYear, setChartYear] = useState(currentYear.toString());
            const [isChartYearFilterActive, setIsChartYearFilterActive] = useState(true); 
            const [isChartMonthFilterActive, setIsChartMonthFilterActive] = useState(true);
            const [chartSelectedMonth, setChartSelectedMonth] = useState(currentMonth);
            const [chartStatusFilter, setChartStatusFilter] = useState('');

            const [productionChartYear, setProductionChartYear] = useState(currentYear.toString());
            const [productionChartMonth, setProductionChartMonth] = useState(currentMonth);
            const [isProductionChartYearFilterActive, setIsProductionChartYearFilterActive] = useState(true); 
            const [isProductionChartMonthFilterActive, setIsProductionChartMonthFilterActive] = useState(true);

            useEffect(() => {
                setShowModal(false);
                setSelectedRecord(null);
                setShowAlertModal(false);
                setAlertTitle('');
                setAlertMessage('');
                setAlertOnConfirm(null);
                setAlertShowCancel(false);
                setAlertConfirmText('ตกลง');
                setAlertCancelText('ยกเลิก');
                setAlertPasswordValue('');
                setAlertShowPasswordInput(false);
                setCurrentImagePreview(null);
            }, [currentPage]);

            const sendToGoogleSheets = async (data, type) => {
                if (!GOOGLE_SHEETS_CONFIG.webAppUrl) return false;
                try {
                    const payload = { action: 'add', type, data };
                    await fetch(GOOGLE_SHEETS_CONFIG.webAppUrl, {
                        method: 'POST', body: JSON.stringify(payload), mode: 'no-cors'
                    });
                    setConnectionStatus('connected');
                    return true;
                } catch (error) {
                    setConnectionStatus('error');
                    openAlert('แจ้งเตือน', 'ไม่สามารถซิงค์กับ Google Sheets ได้ในขณะนี้');
                    return false;
                }
            };

            const deleteFromGoogleSheets = async (id, type) => {
                if (!GOOGLE_SHEETS_CONFIG.webAppUrl) return false;
                setLoadingMessage('กำลังลบข้อมูล...');
                setIsLoading(true);
                try {
                    const payload = { action: 'delete', type, data: { id } };
                    await fetch(GOOGLE_SHEETS_CONFIG.webAppUrl, {
                        method: 'POST', body: JSON.stringify(payload), mode: 'no-cors'
                    });
                    return true;
                } catch (error) {
                    openAlert('ข้อผิดพลาด', 'ไม่สามารถลบข้อมูลจาก Google Sheets ได้');
                    return false;
                } finally {
                    setIsLoading(false);
                }
            };

            const clearSheetInGoogleSheets = async (sheetName) => {
                if (!GOOGLE_SHEETS_CONFIG.webAppUrl) return false;
                setLoadingMessage('กำลังล้างข้อมูล...');
                setIsLoading(true);
                try {
                    const payload = { action: 'clearSheet', type: sheetName };
                    await fetch(GOOGLE_SHEETS_CONFIG.webAppUrl, {
                        method: 'POST', body: JSON.stringify(payload), mode: 'no-cors'
                    });
                    return true;
                } catch (error) {
                    openAlert('ข้อผิดพลาด', `ไม่สามารถล้างข้อมูลในชีต ${sheetName} ได้`);
                    return false;
                } finally {
                    setIsLoading(false);
                }
            };

            const loadFromGoogleSheets = async (manageLoadingState = true) => {
                if (!GOOGLE_SHEETS_CONFIG.webAppUrl) return;
                if(manageLoadingState) {
                    setLoadingMessage('กำลังโหลดข้อมูล...');
                    setIsLoading(true);
                }
                try {
                    const url = `${GOOGLE_SHEETS_CONFIG.webAppUrl}?action=load&t=${Date.now()}`;
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Load failed');
                    const text = await response.text();
                    const result = JSON.parse(text);
                    
                    if (result.success) {
                        if (result.data && result.data.records) {
                            const parsedRecords = result.data.records.map(record => {
                                let imagesArray = [];
                                if (record.images && typeof record.images === 'string') {
                                    try { imagesArray = JSON.parse(record.images); } 
                                    catch (e) { if (record.images.startsWith('data:image')) imagesArray = [record.images]; }
                                }
                                return {
                                    ...record,
                                    quantity: parseFloat(String(record.quantity).replace(/,/g, '')) || 0,
                                    timestamp: parseCSDateString(record.timestamp),
                                    images: imagesArray
                                };
                            });
                            setRecords(parsedRecords);
                        }
                        if (result.data && result.data.production) {
                            const parsedProduction = result.data.production.map(record => ({
                                ...record,
                                bags: parseInt(String(record.bags).replace(/,/g, ''), 10) || 0,
                                kilos: parseInt(String(record.kilos).replace(/,/g, ''), 10) || 0,
                                timestamp: parseCSDateString(record.timestamp)
                            }));
                            setProductionRecords(parsedProduction);
                        }
                        setConnectionStatus('connected');
                    }
                } catch (error) {
                    setConnectionStatus('disconnected');
                } finally {
                    if(manageLoadingState) setIsLoading(false);
                }
            };

            useEffect(() => { loadFromGoogleSheets(); }, []);

            const openAlert = (title, message, onConfirm = null, showCancel = false, confirmText = 'ตกลง', cancelText = 'ยกเล็ก', showPasswordInput = false, correctPassword = '') => {
                setAlertTitle(title); setAlertMessage(message); setAlertOnConfirm(() => onConfirm);
                setAlertShowCancel(showCancel); setAlertConfirmText(confirmText); setAlertCancelText(cancelText);
                setAlertPasswordValue(''); setAlertShowPasswordInput(showPasswordInput); setAlertCorrectPassword(correctPassword);
                setShowAlertModal(true);
            };

            const closeAlert = () => {
                setShowAlertModal(false); setAlertTitle(''); setAlertMessage(''); setAlertOnConfirm(null);
                setAlertShowCancel(false); setAlertConfirmText('ตกลง'); setAlertCancelText('ยกเลิก');
                setAlertPasswordValue(''); setAlertShowPasswordInput(false); setAlertCorrectPassword('');
            };

            const handleTodayProducedChange = (e) => {
                const value = e.target.value;
                setTodayProduced(value);
                setShowConfirmModal(false);
                if (debounceTimer) clearTimeout(debounceTimer);
                if (value && value > 0) {
                    setDebounceTimer(setTimeout(() => setShowConfirmModal(true), 1000));
                }
            };

            const handleConfirmSubmit = () => { handleProductionSubmit(); setShowConfirmModal(false); };
            const handleCancelSubmit = () => { setTodayProduced(''); setShowConfirmModal(false); if (debounceTimer) clearTimeout(debounceTimer); };

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                if (name === 'status') { setFormData(prev => ({ ...prev, [name]: value, name: '' })); } 
                else if (name === 'name' && formData.status === 'ขายออก') { return; } 
                else { setFormData(prev => ({ ...prev, [name]: value })); }
            };

            const handleImageChange = async (e) => {
                const files = Array.from(e.target.files);
                if (files.length > 1) {
                    openAlert('ข้อผิดพลาด', 'สามารถเลือกรูปภาพได้เพียง 1 รูปเท่านั้น');
                    e.target.value = null;
                    return;
                }
                const imagePromises = files.map(file => new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(file);
                }));
                const base64Images = await Promise.all(imagePromises);
                setFormData(prev => ({ ...prev, images: base64Images }));
            };

            const removeImage = (index) => {
                setFormData(prev => ({ ...prev, images: prev.images.filter((_, i) => i !== index) }));
            };

            const handleDetailsClick = (record) => { setSelectedRecord(record); setShowModal(true); };
            const closeModal = () => { setShowModal(false); setSelectedRecord(null); setCurrentImagePreview(null); };

            const getTodayTotalProduction = () => {
                const today = new Date(); today.setHours(0, 0, 0, 0);
                return productionRecords.reduce((total, record) => {
                    const recordDate = new Date(record.timestamp); recordDate.setHours(0, 0, 0, 0);
                    return recordDate.getTime() === today.getTime() ? total + record.bags : total;
                }, 0);
            };

            const getMonthlyTotalProduction = useMemo(() => {
                const today = new Date();
                const currentYear = today.getFullYear();
                const currentMonth = today.getMonth();
                return productionRecords.reduce((total, record) => {
                    const recordDate = new Date(record.timestamp);
                    if (recordDate.getFullYear() === currentYear && recordDate.getMonth() === currentMonth) {
                        return total + record.bags;
                    }
                    return total;
                }, 0);
            }, [productionRecords]);

            const readyForShipping = useMemo(() => {
                const totalProducedBags = productionRecords.reduce((total, record) => total + record.bags, 0);
                const totalSoldBags = records.filter(record => record.status === 'ขายออก').reduce((total, record) => total + (record.quantity / 10), 0);
                return totalProducedBags - totalSoldBags;
            }, [records, productionRecords]);

            const handleProductionSubmit = async () => {
                if (!todayProduced || todayProduced <= 0) { openAlert('ข้อผิดพลาด', 'กรุณากรอกจำนวนที่ทำได้วันนี้'); return; }
                const newProductionRecord = { bags: parseInt(todayProduced), kilos: parseInt(todayProduced) * 10 };
                setLoadingMessage('กำลังบันทึกข้อมูล...');
                setIsLoading(true);
                const success = await sendToGoogleSheets(newProductionRecord, 'Production');
                if (success) {
                    setTimeout(async () => {
                        await loadFromGoogleSheets(false); setIsLoading(false); openAlert('สำเร็จ', 'บันทึกข้อมูลเรียบร้อยแล้ว');
                    }, 2500);
                } else { setIsLoading(false); }
                setTodayProduced('');
            };

            const handleSubmit = async () => {
                if (!formData.quantity || !formData.status || (formData.status === 'ซื้อเข้า' && !formData.name)) {
                    openAlert('ข้อผิดพลาด', 'กรุณากรอกข้อมูลให้ครบถ้วน'); return;
                }
                let finalQuantityForRecord = parseFloat(formData.quantity);
                if (formData.status === 'ขายออก') {
                    const soldBags = parseFloat(formData.quantity);
                    if (soldBags > readyForShipping) {
                        openAlert('ข้อผิดพลาด', `จำนวนที่ขายออก (${soldBags.toLocaleString()} กระสอบ) เกินกว่าจำนวนของพร้อมส่ง (${readyForShipping.toLocaleString()} กระสอบ)`);
                        return;
                    }
                    finalQuantityForRecord = soldBags * 10;
                }
                const newRecord = { name: formData.name || 'ลูกค้า', status: formData.status, quantity: finalQuantityForRecord, images: formData.images };
                setLoadingMessage('กำลังบันทึกข้อมูล...');
                setIsLoading(true);
                const success = await sendToGoogleSheets(newRecord, 'Records');
                if (success) {
                    setTimeout(async () => {
                        await loadFromGoogleSheets(false); setIsLoading(false); openAlert('สำเร็จ', 'บันทึกข้อมูลเรียบร้อยแล้ว');
                    }, 2500);
                } else { setIsLoading(false); }
                setFormData({ name: '', status: '', quantity: '', images: [], selectedDate: todayFormatted });
            };

            const handleDeleteRecord = (id, status, quantity) => {
                openAlert('ยืนยันการลบ', `คุณต้องการลบรายการ ID: ${id}\nกรุณากรอกรหัสผ่านเพื่อยืนยัน`, async () => {
                    await deleteFromGoogleSheets(id, 'Records');
                    setRecords(prevRecords => prevRecords.filter(record => record.id !== id));
                    openAlert('สำเร็จ', 'ลบข้อมูลเรียบร้อยแล้ว');
                }, true, 'ลบ', 'ยกเลิก', true, '4455');
            };

            const handleDeleteProductionRecord = (id, bags) => {
                openAlert('ยืนยันการลบ', `คุณต้องการลบรายการ ID: ${id}\nกรุณากรอกรหัสผ่านเพื่อยืนยัน`, async () => {
                    await deleteFromGoogleSheets(id, 'Production');
                    setProductionRecords(prevRecords => prevRecords.filter(record => record.id !== id));
                    openAlert('สำเร็จ', 'ลบข้อมูลเรียบร้อยแล้ว');
                }, true, 'ลบ', 'ยกเลิก', true, '4455');
            };

            const handleClearPageData = (sheetName) => {
                openAlert(`ยืนยันการล้างข้อมูลหน้า${sheetName === 'Production' ? 'ปริมาณสินค้า' : 'รายงานสถานะ'}`, 
                'การกระทำนี้ไม่สามารถย้อนกลับได้ ข้อมูลทั้งหมดในหน้านี้จะถูกลบอย่างถาวร กรุณากรอกรหัสผ่านเพื่อยืนยัน', async () => {
                    const success = await clearSheetInGoogleSheets(sheetName);
                    if (success) {
                        if (sheetName === 'Production') { setProductionRecords([]); } 
                        else if (sheetName === 'Records') { setRecords([]); }
                        openAlert('สำเร็จ', 'ข้อมูลในหน้านี้ถูกล้างเรียบร้อยแล้ว');
                    }
                }, true, 'ยืนยันการล้างข้อมูล', 'ยกเลิก', true, '062261');
            };

            const getFilteredRecords = () => {
                let filtered = [...records];
                if (filterYear) filtered = filtered.filter(record => record.timestamp.getFullYear() === parseInt(filterYear));
                if (filterMonth) filtered = filtered.filter(record => (record.timestamp.getMonth() + 1).toString() === filterMonth);
                if (filterStatus) filtered = filtered.filter(record => record.status === filterStatus);
                return filtered.reverse();
            };

            const getFilteredProductionRecords = () => {
                let filtered = [...productionRecords];
                if (productionFilterYear) filtered = filtered.filter(record => record.timestamp.getFullYear() === parseInt(productionFilterYear));
                if (productionFilterMonth) filtered = filtered.filter(record => (record.timestamp.getMonth() + 1).toString() === productionFilterMonth);
                return filtered.reverse();
            };

            const getAvailableYears = () => {
                const currentYear = new Date().getFullYear();
                const years = [];
                for (let year = 2020; year <= currentYear + 5; year++) years.push(year);
                return years.sort((a, b) => b - a);
            };

            const getThaiMonthName = (monthNumber) => {
                const monthNames = ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];
                return monthNames[parseInt(monthNumber) - 1];
            };

            const prepareChartData = (dataRecords, filterConfig, dataType) => {
                let filteredData = [...dataRecords];
                let xAxisKey = '';
                let aggregatedData = {};
                let totalSummary = { totalBuyIn: 0, totalSellOut: 0 };

                const selectedYear = parseInt(filterConfig.year);
                const selectedMonth = parseInt(filterConfig.month) - 1;

                if (filterConfig.yearActive) filteredData = filteredData.filter(record => record.timestamp.getFullYear() === selectedYear);
                if (filterConfig.monthActive) filteredData = filteredData.filter(record => record.timestamp.getMonth() === selectedMonth);

                if (filterConfig.yearActive && filterConfig.monthActive) {
                    xAxisKey = 'day';
                    const daysInMonth = new Date(selectedYear, selectedMonth + 1, 0).getDate();
                    for (let day = 1; day <= daysInMonth; day++) {
                        aggregatedData[day] = { day: day };
                        if (dataType === 'general') { aggregatedData[day]['ซื้อเข้า'] = 0; aggregatedData[day]['ขายออก'] = 0; } 
                        else { aggregatedData[day]['จำนวนกระสอบที่ผลิตได้'] = 0; }
                    }
                } else if (filterConfig.yearActive && !filterConfig.monthActive) {
                    xAxisKey = 'month';
                    const monthOrder = ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];
                    monthOrder.forEach(monthName => {
                        aggregatedData[monthName] = { month: monthName };
                        if (dataType === 'general') { aggregatedData[monthName]['ซื้อเข้า'] = 0; aggregatedData[monthName]['ขายออก'] = 0; } 
                        else { aggregatedData[monthName]['จำนวนกระสอบที่ผลิตได้'] = 0; }
                    });
                } else {
                    xAxisKey = 'year';
                    if (dataType === 'production' && filterConfig.monthActive && !filterConfig.yearActive) {
                        xAxisKey = 'period';
                        const allYearsInRecords = [...new Set(dataRecords.map(r => r.timestamp.getFullYear()))].sort((a, b) => a - b);
                        allYearsInRecords.forEach(y => {
                            const monthName = new Date(y, selectedMonth, 1).toLocaleDateString('th-TH', { month: 'long' });
                            const key = `${monthName} ${y}`;
                            aggregatedData[key] = { period: key, 'จำนวนกระสอบที่ผลิตได้': 0 };
                        });
                    } else {
                        const allYearsInRecords = [...new Set(dataRecords.map(r => r.timestamp.getFullYear()))].sort((a, b) => a - b);
                        allYearsInRecords.forEach(y => {
                            aggregatedData[y] = { year: y };
                            if (dataType === 'general') { aggregatedData[y]['ซื้อเข้า'] = 0; aggregatedData[y]['ขายออก'] = 0; } 
                            else { aggregatedData[y]['จำนวนกระสอบที่ผลิตได้'] = 0; }
                        });
                    }
                }

                filteredData.forEach(record => {
                    let key;
                    if (xAxisKey === 'day') key = record.timestamp.getDate();
                    else if (xAxisKey === 'month') key = record.timestamp.toLocaleDateString('th-TH', { month: 'long' });
                    else if (xAxisKey === 'period') {
                        const monthName = new Date(record.timestamp.getFullYear(), record.timestamp.getMonth(), 1).toLocaleDateString('th-TH', { month: 'long' });
                        key = `${monthName} ${record.timestamp.getFullYear()}`;
                    } else key = record.timestamp.getFullYear();

                    if (aggregatedData[key]) {
                        if (dataType === 'general') {
                            if (filterConfig.statusFilter === '' || record.status === filterConfig.statusFilter) {
                                if (record.status === 'ซื้อเข้า') {
                                    aggregatedData[key]['ซื้อเข้า'] += record.quantity;
                                    if (filterConfig.yearActive && filterConfig.monthActive) totalSummary.totalBuyIn += record.quantity;
                                } else {
                                    aggregatedData[key]['ขายออก'] += record.quantity;
                                    if (filterConfig.yearActive && filterConfig.monthActive) totalSummary.totalSellOut += record.quantity;
                                }
                            }
                        } else {
                            aggregatedData[key]['จำนวนกระสอบที่ผลิตได้'] += record.bags;
                        }
                    }
                });

                let finalChartData = Object.values(aggregatedData);
                if (xAxisKey === 'month') {
                    const monthOrder = ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];
                    finalChartData.sort((a, b) => monthOrder.indexOf(a.month) - monthOrder.indexOf(b.month));
                } else if (xAxisKey === 'year' || xAxisKey === 'day') {
                    finalChartData.sort((a, b) => a[xAxisKey] - b[xAxisKey]);
                } else if (xAxisKey === 'period') {
                    finalChartData.sort((a, b) => {
                        const yearA = parseInt(a.period.split(' ')[1]);
                        const yearB = parseInt(b.period.split(' ')[1]);
                        return yearA - yearB;
                    });
                }

                return dataType === 'general' ? { data: finalChartData, xAxisKey, summary: totalSummary } : finalChartData;
            };

            const filteredRecords = useMemo(() => getFilteredRecords(), [records, filterYear, filterMonth, filterStatus]);
            const filteredProductionRecords = useMemo(() => getFilteredProductionRecords(), [productionRecords, productionFilterYear, productionFilterMonth]);
            const availableYears = useMemo(() => getAvailableYears(), []);
            
            const monthlyStats = useMemo(() => {
                let filtered = records;
                if (filterYear) filtered = filtered.filter(record => record.timestamp.getFullYear() === parseInt(filterYear));
                if (filterMonth) {
                    const selectedMonthIndex = parseInt(filterMonth) - 1;
                    filtered = filtered.filter(record => record.timestamp.getMonth() === selectedMonthIndex);
                }
                return filtered.reduce((acc, record) => {
                    if (record.status === 'ซื้อเข้า') acc.totalIn += record.quantity;
                    else if (record.status === 'ขายออก') acc.totalOut += record.quantity;
                    return acc;
                }, { totalIn: 0, totalOut: 0 });
            }, [records, filterYear, filterMonth]);
            
            const currentMonthName = useMemo(() => filterMonth ? getThaiMonthName(filterMonth) : 'เดือนปัจจุบัน', [filterMonth]);

            const { data: chartData, xAxisKey, summary: chartSummary } = useMemo(() => prepareChartData(
                records, { year: chartYear, month: chartSelectedMonth, yearActive: isChartYearFilterActive, monthActive: isChartMonthFilterActive, statusFilter: chartStatusFilter }, 'general'
            ), [records, chartYear, chartSelectedMonth, isChartYearFilterActive, isChartMonthFilterActive, chartStatusFilter]);

            const productionChartData = useMemo(() => prepareChartData(
                productionRecords, { year: productionChartYear, month: productionChartMonth, yearActive: isProductionChartYearFilterActive, monthActive: isProductionChartMonthFilterActive, statusFilter: '' }, 'production'
            ), [productionRecords, productionChartYear, productionChartMonth, isProductionChartYearFilterActive, isProductionChartMonthFilterActive]);

            // Calculate total for production chart status bar
            const productionChartTotal = useMemo(() => {
                if (!productionChartData) return 0;
                return productionChartData.reduce((sum, item) => sum + (item['จำนวนกระสอบที่ผลิตได้'] || 0), 0);
            }, [productionChartData]);

            const chartBrushIndices = useMemo(() => {
                if (!isChartMonthFilterActive || chartData.length <= 10) return { startIndex: undefined, endIndex: undefined };
                const lastDataIndex = chartData.findLastIndex(d => (d['ซื้อเข้า'] || 0) + (d['ขายออก'] || 0) > 0);
                if (lastDataIndex === -1) return { startIndex: Math.max(0, chartData.length - 10), endIndex: chartData.length - 1 };
                const endIndex = Math.min(chartData.length - 1, lastDataIndex + 4);
                return { startIndex: Math.max(0, endIndex - 9), endIndex };
            }, [chartData, isChartMonthFilterActive]);

            const productionBrushIndices = useMemo(() => {
                if (!isProductionChartMonthFilterActive || productionChartData.length <= 10) return { startIndex: undefined, endIndex: undefined };
                const lastDataIndex = productionChartData.findLastIndex(d => d['จำนวนกระสอบที่ผลิตได้'] > 0);
                if (lastDataIndex === -1) return { startIndex: Math.max(0, productionChartData.length - 10), endIndex: productionChartData.length - 1 };
                const endIndex = Math.min(productionChartData.length - 1, lastDataIndex + 4);
                return { startIndex: Math.max(0, endIndex - 9), endIndex };
            }, [productionChartData, isProductionChartMonthFilterActive]);

            if (currentPage === 'inventory') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-emerald-100 to-green-200 p-4 md:p-8 relative">
                        <button onClick={() => openAlert('กรุณากรอกรหัสผ่าน', 'เพื่อเข้าสู่หน้ารายงานสถานะสินค้า', () => setCurrentPage('management'), true, 'ยืนยัน', 'ยกเลิก', true, '4455')} className="absolute top-8 right-8 z-20 bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-5 py-3 rounded-full font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 flex items-center gap-2">
                            <FileText size={20} /> <span>รายงานสถานะสินค้า</span>
                        </button>

                        {isLoading && <LoadingOverlay message={loadingMessage} />}
                        {showAlertModal && <CustomAlertModal title={alertTitle} message={alertMessage} onClose={closeAlert} onConfirm={alertOnConfirm} showCancel={alertShowCancel} confirmText={alertConfirmText} cancelText={alertCancelText} showPasswordInput={alertShowPasswordInput} passwordValue={alertPasswordValue} onPasswordChange={setAlertPasswordValue} correctPassword={alertCorrectPassword} />}
                        
                        {/* Image Modal Logic */}
                        {showModal && selectedRecord && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 sm:p-4">
                                <div className="bg-white rounded-xl sm:rounded-2xl w-full max-w-sm sm:max-w-2xl lg:max-w-4xl p-4 sm:p-6 lg:p-8 shadow-2xl transform scale-100 transition-transform duration-300 ease-out max-h-[95vh] overflow-y-auto">
                                    <h3 className="text-lg sm:text-xl lg:text-2xl font-bold text-gray-800 mb-4 sm:mb-6 text-center">รูปภาพประกอบรายการ</h3>
                                    {selectedRecord.images && selectedRecord.images.length > 0 ? (
                                        <div className="mb-4 sm:mb-6">
                                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 lg:gap-6">
                                                {selectedRecord.images.map((image, index) => (
                                                    <div key={index} className="relative group">
                                                        <img src={image} alt={`ประกอบ ${index + 1}`} className="w-full h-40 sm:h-48 md:h-56 lg:h-80 object-contain rounded-lg shadow-md cursor-pointer hover:opacity-90 transition-opacity border border-gray-200 bg-gray-50" onClick={() => setCurrentImagePreview(image)} />
                                                        <div className="absolute bottom-2 right-2 bg-black bg-opacity-70 text-white px-2 py-1 rounded text-xs sm:text-sm">รูปที่ {index + 1}</div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="text-center py-8 sm:py-12"><Package className="w-12 h-12 sm:w-16 sm:h-16 mx-auto mb-3 sm:mb-4 text-gray-300" /><p className="text-gray-500 text-base sm:text-lg">ไม่มีรูปภาพสำหรับรายการนี้</p></div>
                                    )}
                                    {currentImagePreview && (
                                        <div className="fixed inset-0 bg-black bg-opacity-95 flex items-center justify-center z-50 p-2 sm:p-4">
                                            <div className="relative w-full h-full flex items-center justify-center">
                                                <button onClick={() => setCurrentImagePreview(null)} className="absolute top-2 right-2 sm:top-4 sm:right-4 bg-white bg-opacity-90 hover:bg-opacity-100 rounded-full p-2 sm:p-3 shadow-lg transition-all z-10"><X className="w-5 h-5 sm:w-6 sm:h-6 text-gray-700" /></button>
                                                <img src={currentImagePreview} alt="Preview" className="max-w-full max-h-full object-contain rounded-lg shadow-2xl" style={{ maxWidth: '95vw', maxHeight: '95vh' }} />
                                            </div>
                                        </div>
                                    )}
                                    <button onClick={closeModal} className="w-full bg-blue-500 text-white py-2.5 sm:py-3 rounded-lg font-semibold hover:bg-blue-600 transition-colors text-base sm:text-lg">ปิด</button>
                                </div>
                            </div>
                        )}

                        <div className="max-w-7xl mx-auto space-y-8 md:max-w-full lg:max-w-7xl">
                            <div className="text-center pt-16">
                                <h1 className="text-5xl font-black text-gray-800 mb-2 md:text-6xl">ปริมาณสินค้า</h1>
                                <p className="text-lg text-gray-600 mb-8 md:text-xl">เกล็ดปลาตากแห้ง</p>
                            </div>

                            <div className="flex justify-center">
                                <div className="flex flex-wrap justify-center gap-4 max-w-7xl mx-auto md:max-w-full lg:max-w-7xl">
                                    <div className="bg-gradient-to-br from-emerald-100 to-emerald-200 border border-emerald-300 p-6 rounded-3xl shadow-xl flex-1 min-w-[280px]">
                                        <div className="flex items-center justify-between mb-4"><h3 className="text-lg font-semibold text-emerald-800 md:text-xl">จำนวนที่ทำได้วันนี้</h3><div className="bg-emerald-500 p-2 rounded-full"><Package className="w-6 h-6 text-white" /></div></div>
                                        <div className="text-center relative"><p className="text-5xl font-bold text-emerald-900 mb-2 md:text-6xl">{getTodayTotalProduction().toLocaleString()}</p><div className="bg-emerald-500 text-white px-3 py-1 rounded-full text-sm font-medium absolute bottom-0 right-0">กระสอบ</div></div>
                                    </div>
                                    <div className="bg-gradient-to-br from-violet-100 to-violet-200 border border-violet-300 p-6 rounded-3xl shadow-xl flex-1 min-w-[280px]">
                                        <div className="flex items-center justify-between mb-4"><h3 className="text-lg font-semibold text-violet-800 md:text-xl whitespace-nowrap">จำนวนที่ทำได้ ({currentMonthName})</h3><div className="bg-violet-500 p-2 rounded-full"><Calendar className="w-6 h-6 text-white" /></div></div>
                                        <div className="text-center relative"><p className="text-5xl font-bold text-violet-900 mb-2 md:text-6xl">{getMonthlyTotalProduction.toLocaleString()}</p><div className="bg-violet-500 text-white px-3 py-1 rounded-full text-sm font-medium absolute bottom-0 right-0">กระสอบ</div></div>
                                    </div>
                                    <div className="bg-gradient-to-br from-sky-100 to-sky-200 border border-sky-300 p-6 rounded-3xl shadow-xl flex-1 min-w-[280px]">
                                        <div className="flex items-center justify-between mb-4"><h3 className="text-lg font-semibold text-sky-800 md:text-xl">จำนวนของพร้อมส่ง</h3><div className="bg-sky-500 p-2 rounded-full"><TrendingUp className="w-6 h-6 text-white" /></div></div>
                                        <div className="text-center relative"><p className="text-5xl font-bold text-sky-900 mb-2 md:text-6xl">{readyForShipping.toLocaleString()}</p><div className="bg-sky-500 text-white px-3 py-1 rounded-full text-sm font-medium absolute bottom-0 right-0">กระสอบ</div></div>
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white/80 backdrop-blur-sm rounded-3xl shadow-xl border border-white/20 p-8 md:p-10">
                                <div className="flex items-center gap-3 mb-8">
                                    <div className="bg-gradient-to-r from-emerald-500 to-teal-600 p-3 rounded-2xl"><FlaskConical className="w-6 h-6 text-white" /></div>
                                    <h2 className="text-3xl font-bold bg-gradient-to-r from-emerald-600 to-teal-600 bg-clip-text text-transparent md:text-4xl">บันทึกการผลิตวันนี้</h2>
                                </div>
                                <div className="space-y-6">
                                    <div className="flex items-center justify-center gap-4 md:gap-6">
                                        <label className="text-lg font-semibold text-slate-700 md:text-xl">จำนวนที่ทำได้วันนี้</label>
                                        <input type="number" value={todayProduced} onChange={handleTodayProducedChange} className="w-32 px-4 py-3 text-2xl font-bold text-center border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 bg-white placeholder:text-center md:w-40 md:text-3xl md:py-4" placeholder="0" min="0" />
                                        <span className="text-lg font-semibold text-slate-700 md:text-xl">กระสอบ</span>
                                    </div>
                                </div>
                            </div>

                            {/* Confirm Modal */}
                            {showConfirmModal && (
                                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                                    <div className="bg-white rounded-2xl max-w-md w-full p-8 shadow-2xl transform scale-100 transition-transform duration-300 ease-out">
                                        <div className="text-center">
                                            <h3 className="text-2xl font-bold text-gray-800 mb-4">ยืนยันการบันทึก</h3>
                                            <div className="bg-amber-50 rounded-lg p-4 mb-6">
                                                <p className="text-lg text-amber-800 mb-2">จำนวนที่ทำได้วันนี้</p>
                                                <p className="text-3xl font-bold text-amber-600 mb-2">{parseInt(todayProduced || 0).toLocaleString()} กระสอบ</p>
                                                <p className="text-sm text-gray-600">({(parseInt(todayProduced || 0) * 10).toLocaleString()} กิโลกรัม)</p>
                                                <p className="text-sm text-gray-600 mt-2">วันที่: {new Date().toLocaleDateString('en-GB')}</p>
                                            </div>
                                            <div className="flex gap-4">
                                                <button onClick={handleCancelSubmit} className="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium">ยกเลิก</button>
                                                <button onClick={handleConfirmSubmit} className="flex-1 px-4 py-3 bg-amber-600 text-white rounded-lg hover:bg-amber-700 font-medium">ยืนยัน</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            <div className="bg-white/80 backdrop-blur-sm rounded-3xl shadow-xl border border-white/20 p-8 md:p-10">
                                <div className="flex items-center gap-3 mb-8">
                                    <div className="bg-gradient-to-r from-emerald-500 to-teal-600 p-3 rounded-2xl"><History className="w-6 h-6 text-white" /></div>
                                    <h2 className="text-3xl font-bold bg-gradient-to-r from-emerald-600 to-teal-600 bg-clip-text text-transparent md:text-4xl">รายการผลิตย้อนหลัง</h2>
                                </div>
                                <div className="mb-6 flex flex-wrap items-center gap-4 md:gap-6">
                                    <div className="flex items-center gap-2">
                                        <label className="text-sm font-semibold text-slate-700 whitespace-nowrap md:text-base">ปี:</label>
                                        <select value={productionFilterYear} onChange={(e) => setProductionFilterYear(e.target.value)} className="px-4 py-2 border-2 border-gray-300 rounded-xl bg-white">{availableYears.map(year => (<option key={year} value={year}>{year}</option>))}</select>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <label className="text-sm font-semibold text-slate-700 whitespace-nowrap md:text-base">เดือน:</label>
                                        <select value={productionFilterMonth} onChange={(e) => setProductionFilterMonth(e.target.value)} className="px-4 py-2 border-2 border-gray-300 rounded-xl bg-white">
                                            <option value="">ทั้งหมด</option>
                                            {Array.from({ length: 12 }, (_, i) => i + 1).map(monthNum => {
                                                const monthName = new Date(2000, monthNum - 1, 1).toLocaleDateString('th-TH', { month: 'long' });
                                                return <option key={monthNum} value={monthNum.toString()}>{monthName}</option>;
                                            })}
                                        </select>
                                    </div>
                                </div>
                                <div className="overflow-x-auto max-h-80">
                                    <table className="min-w-full bg-white">
                                        <thead><tr><th className="py-3 px-4 text-center">วันที่/เวลา</th><th className="py-3 px-4 text-center">จำนวนกระสอบที่ผลิตได้</th><th class="py-3 px-4 text-center">จำนวน (KG)</th><th></th></tr></thead>
                                        <tbody>
                                            {filteredProductionRecords.length === 0 ? (<tr><td colSpan="4" className="text-center py-8 text-gray-500">ไม่พบรายการ</td></tr>) : filteredProductionRecords.map((record, idx) => (
                                                <tr key={`prod-${idx}`} className="border-b border-gray-100 hover:bg-gray-50">
                                                    <td className="py-3 px-4 text-center">{formatDateTimeForDisplay(record.timestamp)}</td>
                                                    <td className="py-3 px-4 text-center">{record.bags.toLocaleString()} กระสอบ</td>
                                                    <td className="py-3 px-4 text-center">{record.kilos.toLocaleString()} กิโลกรัม</td>
                                                    <td className="py-3 px-4 text-center"><button onClick={() => handleDeleteProductionRecord(record.id, record.bags)} className="bg-red-100 text-red-700 p-2 rounded-full hover:bg-red-200"><Trash2 className="w-5 h-5" /></button></td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div className="bg-white/80 backdrop-blur-sm rounded-3xl shadow-xl border border-white/20 p-8 md:p-10">
                                <div className="flex items-center gap-3 mb-8">
                                    <div className="bg-gradient-to-r from-emerald-500 to-teal-600 p-3 rounded-2xl"><BarChart3 className="w-6 h-6 text-white" /></div>
                                    <h2 className="text-3xl font-bold bg-gradient-to-r from-emerald-600 to-teal-600 bg-clip-text text-transparent md:text-4xl">จำนวนที่ทำได้ในแต่ละวัน</h2>
                                </div>
                                <div className="mb-4 flex flex-col sm:flex-row items-start sm:items-center gap-4 flex-wrap">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={isProductionChartYearFilterActive} onChange={(e) => { setIsProductionChartYearFilterActive(e.target.checked); if(!e.target.checked) { setIsProductionChartMonthFilterActive(false); setProductionChartMonth(''); }}} className="w-5 h-5 text-blue-600 rounded" />
                                        <label className="font-medium text-gray-700">ปี:</label>
                                        <select value={productionChartYear} onChange={(e) => setProductionChartYear(e.target.value)} className="px-3 py-2 border rounded-lg" disabled={!isProductionChartYearFilterActive}>{availableYears.map(year => <option key={year} value={year}>{year}</option>)}</select>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={isProductionChartMonthFilterActive} onChange={(e) => { setIsProductionChartMonthFilterActive(e.target.checked); if(!e.target.checked) setProductionChartMonth(''); }} className="w-5 h-5 text-blue-600 rounded" disabled={!isProductionChartYearFilterActive} />
                                        <label className="font-medium text-gray-700">เดือน:</label>
                                        <select value={productionChartMonth} onChange={(e) => setProductionChartMonth(e.target.value)} className="px-3 py-2 border rounded-lg" disabled={!isProductionChartMonthFilterActive || !isProductionChartYearFilterActive}>
                                            <option value="">ทั้งหมด</option>
                                            {Array.from({length: 12}, (_, i) => i+1).map(m => <option key={m} value={m}>{new Date(0, m-1).toLocaleDateString('th-TH', {month:'long'})}</option>)}
                                        </select>
                                    </div>
                                </div>

                                {isProductionChartYearFilterActive && isProductionChartMonthFilterActive && productionChartMonth && (
                                    <div className="mt-4 mb-4 flex flex-wrap justify-center items-center gap-4 p-4 bg-emerald-50 rounded-lg shadow-inner md:gap-6 md:text-base">
                                        <span className="text-gray-600 text-base font-semibold">(เดือน{getThaiMonthName(productionChartMonth)} ปี {productionChartYear})</span>
                                        <div className="flex items-center gap-2">
                                            <span className="w-4 h-4 rounded-full bg-emerald-500"></span>
                                            <span className="text-emerald-800">ผลิตรวม: <span className="font-semibold text-emerald-700">{productionChartTotal.toLocaleString()} กระสอบ</span></span>
                                        </div>
                                    </div>
                                )}

                                <ResponsiveContainer width="100%" height={300}>
                                    <BarChart data={productionChartData} margin={{ top: 20, right: 30, left: 20, bottom: 5 }}>
                                        <CartesianGrid strokeDasharray="3 3" />
                                        <XAxis dataKey={(isProductionChartYearFilterActive && isProductionChartMonthFilterActive) ? "day" : (isProductionChartYearFilterActive && !isProductionChartMonthFilterActive) ? "month" : "year"} />
                                        <YAxis label={{ value: 'จำนวนกระสอบ', angle: -90, position: 'insideLeft' }} />
                                        <Tooltip content={<CustomTooltip xAxisKey={xAxisKey} year={isProductionChartYearFilterActive ? parseInt(productionChartYear) : null} month={isProductionChartMonthFilterActive ? parseInt(productionChartMonth) - 1 : null} />} />
                                        <Legend />
                                        <Bar dataKey="จำนวนกระสอบที่ผลิตได้" fill="#8884d8" name="กระสอบ" />
                                        {productionChartData.length > 10 && isProductionChartMonthFilterActive && <Brush dataKey="day" height={30} stroke="#8884d8" startIndex={productionBrushIndices.startIndex} endIndex={productionBrushIndices.endIndex} />}
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                            <div className="mt-8 text-right"><button onClick={() => handleClearPageData('Production')} className="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors flex items-center gap-2 ml-auto"><AlertTriangle className="w-5 h-5" /> ล้างข้อมูลหน้านี้</button></div>
                        </div>
                    </div>
                );
            }

            if (currentPage === 'management') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-100 to-indigo-200 p-4 md:p-8">
                        {isLoading && <LoadingOverlay message={loadingMessage} />}
                        {showAlertModal && <CustomAlertModal title={alertTitle} message={alertMessage} onClose={closeAlert} onConfirm={alertOnConfirm} showCancel={alertShowCancel} confirmText={alertConfirmText} cancelText={alertCancelText} showPasswordInput={alertShowPasswordInput} passwordValue={alertPasswordValue} onPasswordChange={setAlertPasswordValue} correctPassword={alertCorrectPassword} />}
                        
                        {/* Modals for Image Preview */}
                        {showModal && selectedRecord && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                                <div className="bg-white rounded-2xl max-w-4xl w-full p-8 shadow-2xl overflow-y-auto max-h-[90vh]">
                                    <h3 className="text-2xl font-bold mb-6 text-center">รูปภาพประกอบรายการ</h3>
                                    {selectedRecord.images && selectedRecord.images.length > 0 ? (
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 justify-center">
                                            {selectedRecord.images.map((image, index) => (
                                                <div key={index} className="relative group">
                                                    <img src={image} className="w-full h-64 object-contain rounded-lg shadow-md cursor-pointer border" onClick={() => setCurrentImagePreview(image)} />
                                                </div>
                                            ))}
                                        </div>
                                    ) : <div className="text-center py-12 text-gray-500">ไม่มีรูปภาพ</div>}
                                    {currentImagePreview && (
                                        <div className="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4">
                                            <div className="relative max-w-full max-h-full"><button onClick={() => setCurrentImagePreview(null)} className="absolute top-4 right-4 bg-white rounded-full p-2"><X /></button><img src={currentImagePreview} className="max-w-full max-h-[95vh] rounded-lg" /></div>
                                        </div>
                                    )}
                                    <button onClick={closeModal} className="w-full bg-blue-500 text-white py-3 rounded-lg mt-6">ปิด</button>
                                </div>
                            </div>
                        )}

                        <div className="max-w-7xl mx-auto space-y-8">
                            <div className="text-center">
                                <button onClick={() => setCurrentPage('inventory')} className="mb-4 bg-white/80 px-6 py-2 rounded-lg font-medium">← กลับไปหน้าปริมาณสินค้า</button>
                                <h1 className="text-5xl font-black text-gray-800 mb-2">รายงานสถานะสินค้า</h1>
                            </div>

                            <div className="flex flex-wrap justify-center gap-4">
                                <div className="bg-gradient-to-br from-green-100 to-green-200 border-green-300 p-6 rounded-3xl shadow-xl flex-1 min-w-[280px]">
                                    <div className="flex justify-between mb-4"><h3 className="text-lg font-semibold text-green-800">ซื้อเข้า ({currentMonthName})</h3><div className="bg-green-500 p-2 rounded-full"><TrendingUp className="text-white" /></div></div>
                                    <div className="text-center relative"><p className="text-5xl font-bold text-green-900">{monthlyStats.totalIn.toLocaleString()}</p><div className="bg-green-500 text-white px-3 py-1 rounded-full text-sm absolute bottom-0 right-0">KG</div></div>
                                </div>
                                <div className="bg-gradient-to-br from-red-100 to-red-200 border-red-300 p-6 rounded-3xl shadow-xl flex-1 min-w-[280px]">
                                    <div className="flex justify-between mb-4"><h3 className="text-lg font-semibold text-red-800">ขายออก ({currentMonthName})</h3><div className="bg-red-500 p-2 rounded-full"><TrendingDown className="text-white" /></div></div>
                                    <div className="text-center relative"><p className="text-5xl font-bold text-red-900">{monthlyStats.totalOut.toLocaleString()}</p><div className="bg-red-500 text-white px-3 py-1 rounded-full text-sm absolute bottom-0 right-0">KG</div></div>
                                </div>
                                <div className="bg-gradient-to-br from-violet-100 to-violet-200 border-violet-300 p-6 rounded-3xl shadow-xl flex-1 min-w-[280px]">
                                    <div className="flex justify-between mb-4"><h3 className="text-lg font-semibold text-violet-800">ของพร้อมส่ง</h3><div className="bg-violet-500 p-2 rounded-full"><Package className="text-white" /></div></div>
                                    <div className="text-center relative"><p className="text-5xl font-bold text-violet-900">{readyForShipping.toLocaleString()}</p><div className="bg-violet-500 text-white px-3 py-1 rounded-full text-sm absolute bottom-0 right-0">กระสอบ</div></div>
                                </div>
                            </div>

                            <div className="bg-white/80 rounded-3xl shadow-xl p-8">
                                <div className="flex items-center gap-3 mb-8"><div className="bg-gradient-to-r from-blue-500 to-purple-600 p-3 rounded-2xl"><FileText className="text-white" /></div><h2 className="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-600">บันทึกรายการสินค้า</h2></div>
                                <div className="space-y-6">
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                        <div className="space-y-2">
                                            <label className="block text-lg font-semibold text-slate-700">สถานะ</label>
                                            <select name="status" value={formData.status} onChange={handleInputChange} className={`w-full px-4 py-4 border-2 rounded-2xl text-lg ${formData.status==='ซื้อเข้า'?'bg-emerald-50 text-emerald-700':formData.status==='ขายออก'?'bg-sky-50 text-sky-700':'bg-gray-50'}`}>
                                                <option value="">เลือกสถานะ</option><option value="ซื้อเข้า">📦 ซื้อเข้า</option><option value="ขายออก">🚛 ขายออก</option>
                                            </select>
                                        </div>
                                        <div className="space-y-2">
                                            <label className="block text-lg font-semibold">ชื่อลูกค้า/ผู้ขาย</label>
                                            <input type="text" name="name" value={formData.name} onChange={handleInputChange} className="w-full px-4 py-4 border-2 rounded-2xl" placeholder="กรอกชื่อ..." readOnly={formData.status==='ขายออก'} />
                                        </div>
                                    </div>
                                    <div className="space-y-2">
                                        <label className="block text-lg font-semibold">จำนวน ({formData.status==='ขายออก'?'กระสอบ':'กิโลกรัม'})</label>
                                        <input type="number" name="quantity" value={formData.quantity} onChange={handleInputChange} className="w-full px-4 py-4 border-2 rounded-2xl" placeholder="0.00" />
                                    </div>
                                    <div className="space-y-2">
                                        <label className="block text-lg font-semibold">แนบรูปภาพ (1 รูป)</label>
                                        <input type="file" accept="image/*" onChange={handleImageChange} className="w-full px-4 py-4 border-2 border-dashed rounded-2xl" />
                                    </div>
                                    <button onClick={handleSubmit} className="w-full py-4 bg-gradient-to-r from-blue-500 to-purple-600 text-white font-semibold rounded-2xl shadow-lg">บันทึกรายการ</button>
                                </div>
                            </div>

                            <div className="bg-white/80 rounded-3xl shadow-xl p-8">
                                <div className="flex items-center gap-3 mb-8"><div className="bg-gradient-to-r from-indigo-500 to-purple-600 p-3 rounded-2xl"><Package className="text-white" /></div><h2 className="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-600">รายการสินค้าทั้งหมด</h2></div>
                                <div className="mb-6 flex gap-4">
                                    <select value={filterYear} onChange={e=>setFilterYear(e.target.value)} className="border rounded-xl px-4 py-2">{availableYears.map(y=><option key={y} value={y}>{y}</option>)}</select>
                                    <select value={filterMonth} onChange={e=>setFilterMonth(e.target.value)} className="border rounded-xl px-4 py-2"><option value="">ทั้งหมด</option>{Array.from({length:12},(_,i)=>i+1).map(m=><option key={m} value={m}>{new Date(0,m-1).toLocaleDateString('th-TH',{month:'long'})}</option>)}</select>
                                    <select value={filterStatus} onChange={e=>setFilterStatus(e.target.value)} className="border rounded-xl px-4 py-2"><option value="">ทั้งหมด</option><option value="ซื้อเข้า">ซื้อเข้า</option><option value="ขายออก">ขายออก</option></select>
                                </div>
                                <div className="overflow-x-auto max-h-80">
                                    <table className="min-w-full bg-white">
                                        <thead><tr><th className="py-3 px-4">วันที่</th><th className="py-3 px-4">ชื่อ/สถานะ</th><th className="py-3 px-4 text-center">จำนวน (KG)</th><th className="py-3 px-4 text-center">รายละเอียด</th><th className="py-3 px-4"></th></tr></thead>
                                        <tbody>
                                            {filteredRecords.length===0?(<tr><td colSpan="5" className="text-center py-8 text-gray-500">ไม่พบรายการ</td></tr>):filteredRecords.map((r,i)=>(
                                                <tr key={i} className="border-b hover:bg-gray-50">
                                                    <td className="py-3 px-4">{formatDateTimeForDisplay(r.timestamp)}</td>
                                                    <td className="py-3 px-4">{r.name} <span className={`px-2 py-1 rounded text-xs ${r.status==='ซื้อเข้า'?'bg-green-600 text-white':'bg-blue-400 text-white'}`}>{r.status}</span></td>
                                                    <td className="py-3 px-4 text-center">{r.quantity.toLocaleString()} KG {r.status==='ขายออก'&&<span className="block text-xs text-gray-500">({(r.quantity/10).toLocaleString()} กระสอบ)</span>}</td>
                                                    <td className="py-3 px-4 text-center"><button onClick={()=>handleDetailsClick(r)} className="bg-blue-100 text-blue-700 px-3 py-1 rounded">ดูรายละเอียด</button></td>
                                                    <td className="py-3 px-4 text-center"><button onClick={()=>handleDeleteRecord(r.id)} className="bg-red-100 text-red-700 p-2 rounded-full"><Trash2 className="w-5 h-5"/></button></td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div className="bg-white rounded-2xl shadow-lg p-8">
                                <h2 className="text-2xl font-bold mb-6">ภาพรวมปริมาณสินค้า (KG)</h2>
                                <div className="mb-4 flex gap-4 flex-wrap">
                                    <div className="flex items-center gap-2"><input type="checkbox" checked={isChartYearFilterActive} onChange={e=>{setIsChartYearFilterActive(e.target.checked);if(!e.target.checked){setIsChartMonthFilterActive(false);setChartSelectedMonth('')}}} /> ปี: <select value={chartYear} onChange={e=>setChartYear(e.target.value)} disabled={!isChartYearFilterActive} className="border px-2 py-1 rounded">{availableYears.map(y=><option key={y} value={y}>{y}</option>)}</select></div>
                                    <div className="flex items-center gap-2"><input type="checkbox" checked={isChartMonthFilterActive} onChange={e=>{setIsChartMonthFilterActive(e.target.checked);if(!e.target.checked)setChartSelectedMonth('')}} disabled={!isChartYearFilterActive}/> เดือน: <select value={chartSelectedMonth} onChange={e=>setChartSelectedMonth(e.target.value)} disabled={!isChartMonthFilterActive} className="border px-2 py-1 rounded"><option value="">ทั้งหมด</option>{Array.from({length:12},(_,i)=>i+1).map(m=><option key={m} value={m}>{new Date(0,m-1).toLocaleDateString('th-TH',{month:'long'})}</option>)}</select></div>
                                    <div className="flex items-center gap-2">สถานะ: <select value={chartStatusFilter} onChange={e=>setChartStatusFilter(e.target.value)} className="border px-2 py-1 rounded"><option value="">ทั้งหมด</option><option value="ซื้อเข้า">ซื้อเข้า</option><option value="ขายออก">ขายออก</option></select></div>
                                </div>
                                {isChartYearFilterActive && isChartMonthFilterActive && chartSelectedMonth && (
                                    <div className="mt-4 mb-4 flex justify-center items-center gap-4 p-4 bg-blue-50 rounded-lg">
                                        <span className="font-semibold">(เดือน{getThaiMonthName(chartSelectedMonth)} ปี {chartYear})</span>
                                        <span className="text-blue-700">นำเข้า: <span className="font-bold text-green-700">{chartSummary.totalBuyIn.toLocaleString()} KG</span></span>
                                        <span className="text-blue-700">ส่งออก: <span className="font-bold text-blue-700">{chartSummary.totalSellOut.toLocaleString()} KG</span></span>
                                    </div>
                                )}
                                <ResponsiveContainer width="100%" height={300}>
                                    <BarChart data={chartData}>
                                        <CartesianGrid strokeDasharray="3 3" />
                                        <XAxis dataKey={xAxisKey} />
                                        <YAxis />
                                        <Tooltip content={<CustomTooltip xAxisKey={xAxisKey} year={isChartYearFilterActive?parseInt(chartYear):null} month={isChartMonthFilterActive?parseInt(chartSelectedMonth)-1:null}/>}/>
                                        <Legend />
                                        {chartStatusFilter!=='ขายออก' && <Bar dataKey="ซื้อเข้า" fill="#4CAF50" name="ซื้อเข้า (KG)" />}
                                        {chartStatusFilter!=='ซื้อเข้า' && <Bar dataKey="ขายออก" fill="#2196F3" name="ขายออก (KG)" />}
                                        {chartData.length > 10 && isChartMonthFilterActive && <Brush dataKey="day" height={30} stroke="#8884d8" startIndex={chartBrushIndices.startIndex} endIndex={chartBrushIndices.endIndex} />}
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                            <div className="mt-8 text-right"><button onClick={()=>handleClearPageData('Records')} className="bg-red-600 text-white font-bold py-2 px-4 rounded-lg"><AlertTriangle className="w-5 h-5"/> ล้างข้อมูลหน้านี้</button></div>
                        </div>
                    </div>
                );
            }

            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
