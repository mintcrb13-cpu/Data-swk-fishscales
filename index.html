<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SWK - ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (HTML)</title>

  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- ApexCharts -->
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Prompt', 'sans-serif'] }
        }
      }
    }
  </script>

  <style>
    html { scroll-behavior: smooth; }
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #2563eb; border-radius: 5px; }
    ::-webkit-scrollbar-thumb:hover { background: #1d4ed8; }

    .custom-scrollbar::-webkit-scrollbar { height: 16px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #8b5cf6; border-radius: 8px; }

    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #2563eb;
      border-radius: 50%;
      width: 40px; height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
  </style>
</head>

<body class="font-sans bg-gradient-to-br from-blue-100 to-indigo-200 min-h-screen">
  <!-- Header -->
  <header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b border-white/60 shadow-sm">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-2xl bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center text-white">
          <i class="fa-solid fa-chart-column"></i>
        </div>
        <div>
          <div class="font-bold text-gray-800 text-lg leading-tight">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
          <div class="text-sm text-gray-500 leading-tight">‡πÄ‡∏Å‡∏•‡πá‡∏î‡∏õ‡∏•‡∏≤‡∏ï‡∏≤‡∏Å‡πÅ‡∏´‡πâ‡∏á (HTML + ApexCharts)</div>
        </div>
      </div>

      <button onclick="openLogin()" class="px-5 py-2.5 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold shadow hover:shadow-lg transition flex items-center gap-2">
        <i class="fa-solid fa-lock"></i>
        ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
      </button>
    </div>
  </header>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[100]">
    <div class="flex flex-col items-center">
      <div class="loader mb-4"></div>
      <p id="loading-text" class="text-white text-lg font-semibold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...</p>
    </div>
  </div>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">

    <!-- Stats -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-gradient-to-br from-green-100 to-green-200 border border-green-300 p-6 rounded-3xl shadow-xl">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-green-800">‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</h3>
          <div class="bg-green-500 p-2 rounded-full text-white"><i class="fa-solid fa-arrow-trend-up"></i></div>
        </div>
        <div class="text-center relative">
          <p class="text-5xl font-bold text-green-900 mb-1" id="stat-in">0</p>
          <div class="absolute bottom-0 right-0 bg-green-500 text-white px-3 py-1 rounded-full text-sm font-semibold">KG</div>
        </div>
      </div>

      <div class="bg-gradient-to-br from-red-100 to-red-200 border border-red-300 p-6 rounded-3xl shadow-xl">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-red-800">‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</h3>
          <div class="bg-red-500 p-2 rounded-full text-white"><i class="fa-solid fa-arrow-trend-down"></i></div>
        </div>
        <div class="text-center relative">
          <p class="text-5xl font-bold text-red-900 mb-1" id="stat-out">0</p>
          <div class="absolute bottom-0 right-0 bg-red-500 text-white px-3 py-1 rounded-full text-sm font-semibold">KG</div>
        </div>
      </div>

      <div class="bg-gradient-to-br from-violet-100 to-violet-200 border border-violet-300 p-6 rounded-3xl shadow-xl">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-violet-800">‡∏Ç‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á</h3>
          <div class="bg-violet-500 p-2 rounded-full text-white"><i class="fa-solid fa-box-open"></i></div>
        </div>
        <div class="text-center relative">
          <p class="text-5xl font-bold text-violet-900 mb-1" id="stat-stock">0</p>
          <div class="absolute bottom-0 right-0 bg-violet-500 text-white px-3 py-1 rounded-full text-sm font-semibold">‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö</div>
        </div>
      </div>
    </section>

    <!-- Form -->
    <section class="bg-white/80 backdrop-blur rounded-3xl shadow-xl border border-white/20 p-6 md:p-10">
      <div class="flex items-center gap-3 mb-8">
        <div class="bg-gradient-to-r from-blue-500 to-purple-600 p-3 rounded-2xl text-white">
          <i class="fa-solid fa-file-pen"></i>
        </div>
        <h2 class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
          ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        </h2>
      </div>

      <form id="inv-form" class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="space-y-2">
            <label class="block text-lg font-semibold text-slate-700">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
            <select id="inv-status" class="w-full px-4 py-4 border-2 rounded-2xl text-lg font-medium bg-gray-50 border-gray-300 focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500 transition">
              <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ --</option>
              <option value="‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤">üì¶ ‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤</option>
              <option value="‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å">üöõ ‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å</option>
            </select>
          </div>

          <div class="space-y-2">
            <label class="block text-lg font-semibold text-slate-700">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤/‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢</label>
            <input id="inv-name" type="text" class="w-full px-4 py-4 border-2 rounded-2xl text-lg bg-white border-gray-300 focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500 transition" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠..."/>
          </div>
        </div>

        <div class="space-y-2">
          <label class="block text-lg font-semibold text-slate-700" id="inv-qty-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (KG)</label>
          <div class="relative">
            <input id="inv-qty" type="number" step="0.01" class="w-full px-4 py-4 pr-16 border-2 rounded-2xl text-lg bg-white border-gray-300 focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500 transition" placeholder="0.00"/>
            <div class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 font-semibold" id="inv-unit">KG</div>
          </div>
          <p class="text-sm text-gray-500" id="inv-hint"></p>
        </div>

        <div class="space-y-2">
          <label class="block text-lg font-semibold text-slate-700">‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 2 ‡∏£‡∏π‡∏õ)</label>
          <div class="border-2 border-dashed border-gray-300 rounded-2xl p-6 text-center bg-gray-50 hover:bg-gray-100 transition relative">
            <input id="inv-images" type="file" multiple accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer"/>
            <div id="upload-placeholder">
              <i class="fa-solid fa-cloud-arrow-up text-3xl text-gray-400 mb-2"></i>
              <p class="text-gray-500">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</p>
            </div>
            <div id="preview-container" class="hidden grid grid-cols-2 gap-4 mt-3"></div>
          </div>
        </div>

        <button type="submit" class="w-full py-4 rounded-2xl text-xl font-bold text-white bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 shadow-lg hover:shadow-xl transition">
          üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        </button>
      </form>
    </section>

    <!-- Table -->
    <section class="bg-white/80 backdrop-blur rounded-3xl shadow-xl border border-white/20 p-6 md:p-10">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
        <div class="flex items-center gap-3">
          <div class="bg-gradient-to-r from-indigo-500 to-purple-600 p-3 rounded-2xl text-white">
            <i class="fa-solid fa-table-list"></i>
          </div>
          <h2 class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
            ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
          </h2>
        </div>

        <div class="flex flex-wrap gap-3 items-center bg-white/70 rounded-2xl p-3 border">
          <select id="filter-year" class="px-3 py-2 border rounded-xl bg-white focus:ring-2 focus:ring-indigo-500 text-sm"></select>
          <select id="filter-month" class="px-3 py-2 border rounded-xl bg-white focus:ring-2 focus:ring-indigo-500 text-sm"></select>
          <select id="filter-status" class="px-3 py-2 border rounded-xl bg-white focus:ring-2 focus:ring-indigo-500 text-sm">
            <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
            <option value="‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤">‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤</option>
            <option value="‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å">‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å</option>
          </select>
          <button onclick="fetchData()" class="px-4 py-2 rounded-xl bg-indigo-600 text-white font-semibold hover:bg-indigo-700 transition text-sm flex items-center gap-2">
            <i class="fa-solid fa-rotate"></i> ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
          </button>
        </div>
      </div>

      <div class="overflow-auto max-h-[520px] rounded-2xl border border-gray-200 bg-white">
        <table class="w-full text-left border-collapse">
          <thead class="bg-gray-100 text-gray-700 text-base sticky top-0 z-10">
            <tr>
              <th class="p-4 whitespace-nowrap text-center">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤</th>
              <th class="p-4 text-center">‡∏ä‡∏∑‡πà‡∏≠ / ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              <th class="p-4 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
              <th class="p-4 text-center">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
              <th class="p-4 text-center"></th>
            </tr>
          </thead>
          <tbody id="table-body" class="divide-y divide-gray-100 text-gray-700"></tbody>
        </table>
      </div>

      <div class="mt-6 text-right">
        <button onclick="clearSheetData()" class="bg-red-600 text-white font-bold py-2.5 px-5 rounded-xl hover:bg-red-700 transition flex items-center gap-2 ml-auto">
          <i class="fa-solid fa-skull"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ
        </button>
      </div>
    </section>

    <!-- Chart -->
    <section class="bg-white/80 backdrop-blur rounded-3xl shadow-xl border border-white/20 p-6 md:p-10">
      <div class="flex flex-col gap-4 mb-6">
        <div class="flex items-center gap-3">
          <div class="bg-gradient-to-r from-indigo-500 to-purple-600 p-3 rounded-2xl text-white">
            <i class="fa-solid fa-chart-bar"></i>
          </div>
          <h2 class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
            ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤ / ‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å)
          </h2>
        </div>

        <div class="flex flex-wrap gap-4 items-center bg-gray-50 p-3 rounded-2xl border border-gray-100">
          <div class="flex items-center gap-2">
            <input type="checkbox" id="chk-chart-month" checked onchange="toggleChartMode()" class="w-5 h-5 rounded border-gray-300">
            <label for="chk-chart-month" class="text-sm font-semibold text-gray-700">‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô)</label>
          </div>

          <div class="flex items-center gap-2">
            <span class="text-sm font-medium text-gray-700">‡∏õ‡∏µ:</span>
            <select id="chart-year" onchange="renderChart()" class="px-3 py-2 border rounded-xl focus:ring-2 focus:ring-indigo-500 bg-white text-sm"></select>
          </div>

          <div class="flex items-center gap-2">
            <span class="text-sm font-medium text-gray-700">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</span>
            <select id="chart-month" onchange="renderChart()" class="px-3 py-2 border rounded-xl focus:ring-2 focus:ring-indigo-500 bg-white text-sm">
              <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
            </select>
          </div>

          <div class="flex items-center gap-2 border-l pl-4 border-gray-300">
            <span class="text-sm font-medium text-gray-700">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span>
            <select id="chart-status" onchange="renderChart()" class="px-3 py-2 border rounded-xl focus:ring-2 focus:ring-indigo-500 bg-white text-sm">
              <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
              <option value="‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤">‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤</option>
              <option value="‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å">‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å</option>
            </select>
          </div>
        </div>
      </div>

      <div class="flex w-full h-[450px] border border-gray-100 rounded-2xl overflow-hidden bg-white">
        <!-- Fixed Y -->
        <div class="w-[90px] h-full flex-shrink-0 relative z-10 bg-white pb-12">
          <div id="chart-y" class="absolute -top-2 -left-2 w-[100px] h-full"></div>
        </div>
        <!-- Scrollable main -->
        <div id="chart-scroller" class="flex-grow h-full overflow-x-auto overflow-y-hidden custom-scrollbar pb-12">
          <div id="chart-main" class="h-full"></div>
        </div>
      </div>
    </section>

  </main>

  <!-- Image Modal -->
  <div id="img-modal" class="fixed inset-0 z-[120] hidden bg-black/95 items-center justify-center p-4" onclick="closeImageModal()">
    <button class="absolute top-6 right-6 text-white text-4xl hover:text-gray-300 focus:outline-none">&times;</button>
    <div class="max-h-[90vh] max-w-[90vw] overflow-auto flex flex-col items-center gap-4" onclick="event.stopPropagation()">
      <div id="img-modal-container" class="flex flex-col gap-4"></div>
    </div>
  </div>

<script>
  // =============================
  // CONFIG
  // =============================
  const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyfxWs81WEsrizNnTi82tZAOH_EHX1hKnvUoqsARpYch3TTjEqz5oepiol_vWQ4lK3G0g/exec';

  // App data
  let appData = { records: [], production: [] };
  let charts = { y: null, main: null };
  let currentImagesBase64 = [];

  // =============================
  // Helpers
  // =============================
  const getThaiMonthName = (m) => ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô','‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'][m-1];

  function parseDate(str) {
    if(!str) return new Date();
    if(str instanceof Date) return str;
    if(typeof str === "string" && str.includes('/')) {
      // expect "dd/mm/yyyy, HH:MM:SS"
      const parts = str.split(', ');
      const dPart = parts[0];
      const tPart = parts[1] || '00:00:00';
      const [dd, mm, yyyy] = dPart.split('/');
      return new Date(`${yyyy}-${mm}-${dd}T${tPart}`);
    }
    return new Date(str);
  }

  function formatDateThai(d) {
    const date = new Date(d);
    if (isNaN(date.getTime())) return '';
    const dd = String(date.getDate()).padStart(2,'0');
    const mm = String(date.getMonth()+1).padStart(2,'0');
    const yy = date.getFullYear()+543;
    const hh = String(date.getHours()).padStart(2,'0');
    const mi = String(date.getMinutes()).padStart(2,'0');
    return `${dd}/${mm}/${yy} ${hh}:${mi} ‡∏ô.`;
  }

  function showLoading(message="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...") {
    const overlay = document.getElementById("loading-overlay");
    document.getElementById("loading-text").innerText = message;
    overlay.classList.remove("hidden");
    overlay.classList.add("flex");
  }

  function hideLoading() {
    const overlay = document.getElementById("loading-overlay");
    overlay.classList.add("hidden");
    overlay.classList.remove("flex");
  }

  // ‚úÖ ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á (‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö)
  function calculateReadyStockBags() {
    const totalProducedBags = appData.production.reduce((s, r) => s + (parseInt(r.bags) || 0), 0);
    const totalSoldBags = appData.records
      .filter(r => r.status === '‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å')
      .reduce((s, r) => s + ((parseFloat(r.quantity) || 0) / 10), 0);
    return Math.max(0, totalProducedBags - totalSoldBags);
  }

  // =============================
  // Login
  // =============================
  function openLogin() {
    Swal.fire({
      title: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•',
      text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (4455)',
      input: 'password',
      inputPlaceholder: '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô',
      showCancelButton: true,
      confirmButtonText: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö',
      cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
    }).then(res => {
      if (!res.isConfirmed) return;
      if (res.value === '4455') {
        Swal.fire({ icon:'success', title:'‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1200, showConfirmButton:false });
      } else {
        Swal.fire({ icon:'error', title:'‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á' });
      }
    });
  }

  // =============================
  // Populate Filters
  // =============================
  function populateFilterOptions() {
    const curYear = new Date().getFullYear();
    const curMonth = new Date().getMonth() + 1;

    const years = [];
    for (let y = 2020; y <= curYear + 5; y++) years.push(y);
    years.reverse();

    const yearOpts = years.map(y => ({ value: y, text: `${y+543}` }));
    const monthOpts = Array.from({length: 12}, (_,i) => ({ value: i+1, text: getThaiMonthName(i+1) }));

    // Table filters
    const fy = document.getElementById("filter-year");
    const fm = document.getElementById("filter-month");
    fy.innerHTML = `<option value="">‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ</option>` + yearOpts.map(o => `<option value="${o.value}">${o.text}</option>`).join('');
    fm.innerHTML = `<option value="">‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>` + monthOpts.map(o => `<option value="${o.value}">${o.text}</option>`).join('');

    // Chart filters
    const cy = document.getElementById("chart-year");
    const cm = document.getElementById("chart-month");
    cy.innerHTML = yearOpts.map(o => `<option value="${o.value}">${o.text}</option>`).join('');
    cm.innerHTML = `<option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>` + monthOpts.map(o => `<option value="${o.value}">${o.text}</option>`).join('');

    // Default values
    fy.value = curYear;
    fm.value = curMonth;
    document.getElementById("filter-status").value = "";

    cy.value = curYear;
    cm.value = curMonth;
    document.getElementById("chart-status").value = "";
  }

  // =============================
  // Form logic
  // =============================
  function toggleInvForm(type) {
    const nameInput = document.getElementById("inv-name");
    const qtyLabel = document.getElementById("inv-qty-label");
    const unit = document.getElementById("inv-unit");
    const hint = document.getElementById("inv-hint");

    if (type === "‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å") {
      nameInput.value = "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ";
      nameInput.readOnly = true;
      nameInput.classList.add("bg-gray-100");

      qtyLabel.innerText = "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö)";
      unit.innerText = "‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö";
      hint.innerHTML = `‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô <b>‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏° (‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö x 10)</b> ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥`;
    } else {
      nameInput.value = "";
      nameInput.readOnly = false;
      nameInput.classList.remove("bg-gray-100");

      qtyLabel.innerText = "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°)";
      unit.innerText = "KG";
      hint.innerHTML = "";
    }
  }

  document.getElementById("inv-status").addEventListener("change", (e) => {
    toggleInvForm(e.target.value);
  });

  // Image preview (max 2)
  document.getElementById("inv-images").addEventListener("change", (e) => {
    const files = Array.from(e.target.files || []);
    const preview = document.getElementById("preview-container");
    const placeholder = document.getElementById("upload-placeholder");

    preview.innerHTML = "";
    currentImagesBase64 = [];

    if (files.length > 2) {
      Swal.fire({ icon:'error', title:'‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 2 ‡∏£‡∏π‡∏õ' });
      e.target.value = "";
      preview.classList.add("hidden");
      placeholder.classList.remove("hidden");
      return;
    }

    if (files.length === 0) {
      preview.classList.add("hidden");
      placeholder.classList.remove("hidden");
      return;
    }

    placeholder.classList.add("hidden");
    preview.classList.remove("hidden");

    files.forEach(file => {
      const reader = new FileReader();
      reader.onload = () => {
        const base64 = reader.result;
        currentImagesBase64.push(base64);
        const div = document.createElement("div");
        div.className = "relative group";
        div.innerHTML = `
          <img src="${base64}" class="w-full h-24 object-cover rounded-xl border border-gray-200 bg-white" />
        `;
        preview.appendChild(div);
      };
      reader.readAsDataURL(file);
    });
  });

  // Submit form
  document.getElementById("inv-form").addEventListener("submit", async (e) => {
    e.preventDefault();

    const status = document.getElementById("inv-status").value;
    const name = document.getElementById("inv-name").value.trim();
    let qty = parseFloat(document.getElementById("inv-qty").value);

    if (!status || !name || !qty || qty <= 0) {
      return Swal.fire({ icon:'warning', title:'‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', text:'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á' });
    }

    // ‚úÖ FIX: ‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å = ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô "‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö" ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô KG
    let storeQtyKg = qty;
    if (status === "‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å") {
      const stockBags = calculateReadyStockBags();
      if (qty > stockBags) {
        return Swal.fire({ icon:'error', title:'‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏≠', text:`‡∏Ç‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á ${stockBags.toLocaleString()} ‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö ‡πÅ‡∏ï‡πà‡∏Ñ‡∏∏‡∏ì‡∏Ç‡∏≤‡∏¢ ${qty.toLocaleString()} ‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö` });
      }
      storeQtyKg = qty * 10; // <-- ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
    }

    const payload = {
      status,
      name,
      quantity: storeQtyKg,
      images: currentImagesBase64
    };

    await sendData("add", "Records", payload);

    // reset
    document.getElementById("inv-form").reset();
    document.getElementById("preview-container").innerHTML = "";
    document.getElementById("preview-container").classList.add("hidden");
    document.getElementById("upload-placeholder").classList.remove("hidden");
    currentImagesBase64 = [];
    toggleInvForm(""); // reset UI labels
  });

  // =============================
  // Google Sheets IO
  // =============================
  async function sendData(action, type, data) {
    showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");
    try {
      await fetch(GOOGLE_SCRIPT_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action, type, data })
      });

      setTimeout(async () => {
        await fetchData(false);
        hideLoading();
        Swal.fire({ icon:'success', title:'‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', timer: 1300, showConfirmButton:false });
      }, 1600);

    } catch (err) {
      hideLoading();
      Swal.fire({ icon:'error', title:'‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: err.message });
    }
  }

  async function fetchData(showOverlay = true) {
    if (showOverlay) showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");
    try {
      const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=load&t=${Date.now()}`);
      const result = await res.json();

      if (!result.success) throw new Error("Load failed");

      // Production
      appData.production = (result.data.production || []).map(r => ({
        ...r,
        bags: parseInt(r.bags) || 0,
        kilos: parseInt(r.kilos) || 0,
        timestamp: r.timestamp
      }));

      // Records + images parsing
      appData.records = (result.data.records || []).map(r => {
        let imgs = [];
        if (r.images) {
          try { imgs = JSON.parse(r.images); }
          catch(e) {
            if (typeof r.images === "string" && r.images.startsWith("data:image")) imgs = [r.images];
          }
        }
        return {
          ...r,
          quantity: parseFloat(r.quantity) || 0,
          images: imgs,
          timestamp: r.timestamp
        };
      });

      renderStats();
      renderTable();
      renderChart();

    } catch (e) {
      Swal.fire({ icon:'error', title:'‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', text:'‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏≤‡∏£ Deploy WebApp ‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Google Script' });
    } finally {
      if (showOverlay) hideLoading();
    }
  }

  async function deleteData(id) {
    const res = await Swal.fire({
      title: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö",
      text: "‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (4455)",
      input: "password",
      showCancelButton: true,
      confirmButtonText: "‡∏•‡∏ö",
      cancelButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å",
      confirmButtonColor: "#ef4444"
    });
    if (!res.isConfirmed) return;
    if (res.value !== "4455") return Swal.fire({ icon:"error", title:"‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á" });

    showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");
    try {
      await fetch(GOOGLE_SCRIPT_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "delete", type: "Records", data: { id } })
      });

      setTimeout(async () => {
        await fetchData(false);
        hideLoading();
        Swal.fire({ icon:"success", title:"‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", timer: 1200, showConfirmButton:false });
      }, 1500);

    } catch (e) {
      hideLoading();
      Swal.fire({ icon:"error", title:"‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" });
    }
  }

  async function clearSheetData() {
    const res = await Swal.fire({
      title: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?",
      text: "‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô 062261)",
      icon: "warning",
      input: "password",
      showCancelButton: true,
      confirmButtonText: "‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
      cancelButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å",
      confirmButtonColor: "#ef4444"
    });
    if (!res.isConfirmed) return;
    if (res.value !== "062261") return Swal.fire({ icon:"error", title:"‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á" });

    showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");
    try {
      await fetch(GOOGLE_SCRIPT_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "clearSheet", type: "Records" })
      });

      setTimeout(async () => {
        await fetchData(false);
        hideLoading();
        Swal.fire({ icon:"success", title:"‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", timer: 1200, showConfirmButton:false });
      }, 1600);

    } catch(e) {
      hideLoading();
      Swal.fire({ icon:"error", title:"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î" });
    }
  }

  // =============================
  // Rendering
  // =============================
  function renderStats() {
    const now = new Date();
    const y = now.getFullYear();
    const m = now.getMonth();

    let totalIn = 0;
    let totalOut = 0;

    appData.records.forEach(r => {
      const d = parseDate(r.timestamp);
      if (d.getFullYear() === y && d.getMonth() === m) {
        if (r.status === "‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤") totalIn += r.quantity;
        if (r.status === "‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å") totalOut += r.quantity;
      }
    });

    document.getElementById("stat-in").innerText = totalIn.toLocaleString();
    document.getElementById("stat-out").innerText = totalOut.toLocaleString();
    document.getElementById("stat-stock").innerText = calculateReadyStockBags().toLocaleString();
  }

  function getFilteredRecords() {
    const fy = document.getElementById("filter-year").value;
    const fm = document.getElementById("filter-month").value;
    const fs = document.getElementById("filter-status").value;

    let filtered = [...appData.records];

    if (fy) filtered = filtered.filter(r => parseDate(r.timestamp).getFullYear() == fy);
    if (fm) filtered = filtered.filter(r => (parseDate(r.timestamp).getMonth() + 1) == fm);
    if (fs) filtered = filtered.filter(r => r.status === fs);

    filtered.sort((a,b) => parseDate(b.timestamp) - parseDate(a.timestamp));
    return filtered;
  }

  function openImageModal(images) {
    if (!images || images.length === 0) return;
    const modal = document.getElementById("img-modal");
    const container = document.getElementById("img-modal-container");
    container.innerHTML = "";

    (Array.isArray(images) ? images : [images]).forEach(src => {
      const img = document.createElement("img");
      img.src = src;
      img.className = "max-w-full rounded-xl shadow-2xl border-4 border-white bg-white";
      container.appendChild(img);
    });

    modal.classList.remove("hidden");
    modal.classList.add("flex");
  }

  function closeImageModal() {
    const modal = document.getElementById("img-modal");
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  }

  function renderTable() {
    const tbody = document.getElementById("table-body");
    const data = getFilteredRecords();

    if (data.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="5" class="p-10 text-center text-gray-500">
            <div class="text-5xl mb-2"><i class="fa-solid fa-box-open text-gray-300"></i></div>
            ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
          </td>
        </tr>
      `;
      return;
    }

    tbody.innerHTML = "";

    data.forEach(r => {
      const dateStr = formatDateThai(parseDate(r.timestamp));

      // ‚úÖ FIX DISPLAY:
      // - ‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤: ‡πÅ‡∏™‡∏î‡∏á KG ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
      // - ‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å: ‡πÅ‡∏™‡∏î‡∏á KG ‡∏ö‡∏ô ‡πÅ‡∏•‡∏∞ (‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö) ‡∏•‡πà‡∏≤‡∏á
      let amountHtml = "";
      if (r.status === "‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å") {
        const bags = (r.quantity / 10);
        amountHtml = `
          <div class="font-semibold">${r.quantity.toLocaleString()} ‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°</div>
          <div class="text-sm text-gray-500">(${bags.toLocaleString()} ‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö)</div>
        `;
      } else {
        amountHtml = `<div class="font-semibold">${r.quantity.toLocaleString()} ‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°</div>`;
      }

      const statusBadge = r.status === "‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤"
        ? `<span class="text-xs px-2 py-0.5 rounded-full bg-green-600 text-white font-bold">‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤</span>`
        : `<span class="text-xs px-2 py-0.5 rounded-full bg-blue-500 text-white font-bold">‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å</span>`;

      const detailBtn = (r.images && r.images.length > 0)
        ? `<button class="text-indigo-600 hover:text-indigo-800 hover:underline font-semibold" onclick='openImageModal(${JSON.stringify(r.images).replace(/"/g, "&quot;")})'>
              <i class="fa-solid fa-circle-info"></i> ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
           </button>`
        : `<span class="text-gray-400 text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ</span>`;

      const tr = document.createElement("tr");
      tr.className = "hover:bg-gray-50 transition text-base";
      tr.innerHTML = `
        <td class="p-4 text-center whitespace-nowrap">${dateStr}</td>
        <td class="p-4 text-center">
          <div class="flex items-center justify-center gap-2 flex-wrap">
            <span class="font-medium">${(r.name || "").toString()}</span>
            ${statusBadge}
          </div>
        </td>
        <td class="p-4 text-center">${amountHtml}</td>
        <td class="p-4 text-center">${detailBtn}</td>
        <td class="p-4 text-center">
          <button onclick="deleteData('${r.id}')" class="w-10 h-10 rounded-full bg-red-100 hover:bg-red-200 text-red-600 hover:text-red-700 transition shadow-sm">
            <i class="fa-solid fa-trash-can"></i>
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // =============================
  // Chart
  // =============================
  function toggleChartMode() {
    const useMonth = document.getElementById("chk-chart-month").checked;
    document.getElementById("chart-year").disabled = !useMonth; // if not month mode => all years
    document.getElementById("chart-month").disabled = !useMonth;
    renderChart();
  }

  function renderChart() {
    const useMonthMode = document.getElementById("chk-chart-month").checked;

    const yearVal = parseInt(document.getElementById("chart-year").value) || new Date().getFullYear();
    const monthVal = document.getElementById("chart-month").value;
    const statusVal = document.getElementById("chart-status").value;

    const isAllMonths = monthVal === "all";
    const selectedMonth = parseInt(monthVal);

    // yearly mode (if checkbox off)
    if (!useMonthMode) {
      const map = {};
      appData.records.forEach(r => {
        if (statusVal && r.status !== statusVal) return;
        const d = parseDate(r.timestamp);
        const y = d.getFullYear();
        if (!map[y]) map[y] = { buy: 0, sell: 0 };
        if (r.status === "‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤") map[y].buy += r.quantity;
        if (r.status === "‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å") map[y].sell += r.quantity;
      });

      const years = Object.keys(map).sort((a,b)=>a-b);
      const categories = years.map(y => (parseInt(y)+543).toString());
      const buySeries = years.map(y => map[y].buy);
      const sellSeries = years.map(y => map[y].sell);

      renderApexInventory(categories, buySeries, sellSeries, false);
      return;
    }

    // monthly aggregate (all months)
    if (isAllMonths) {
      const map = {};
      for (let i=0;i<12;i++) map[i] = { buy:0, sell:0 };

      appData.records.forEach(r => {
        if (statusVal && r.status !== statusVal) return;
        const d = parseDate(r.timestamp);
        if (d.getFullYear() !== yearVal) return;
        const m = d.getMonth();
        if (r.status === "‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤") map[m].buy += r.quantity;
        if (r.status === "‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å") map[m].sell += r.quantity;
      });

      const categories = Array.from({length:12}, (_,i)=>getThaiMonthName(i+1));
      const buySeries = Array.from({length:12}, (_,i)=>map[i].buy);
      const sellSeries = Array.from({length:12}, (_,i)=>map[i].sell);

      renderApexInventory(categories, buySeries, sellSeries, false);
      return;
    }

    // daily mode (specific month)
    const startDate = new Date(yearVal, selectedMonth-1, 1);
    const endDate = new Date(yearVal, selectedMonth, 0);
    startDate.setHours(0,0,0,0);
    endDate.setHours(0,0,0,0);

    const dailyMap = {};
    let iter = new Date(startDate);
    while (iter <= endDate) {
      const key = `${iter.getFullYear()}-${String(iter.getMonth()+1).padStart(2,'0')}-${String(iter.getDate()).padStart(2,'0')}`;
      dailyMap[key] = { buy: 0, sell: 0 };
      iter.setDate(iter.getDate()+1);
    }

    appData.records.forEach(r => {
      if (statusVal && r.status !== statusVal) return;
      const d = parseDate(r.timestamp);
      d.setHours(0,0,0,0);
      if (d < startDate || d > endDate) return;

      const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      if (!dailyMap[key]) return;
      if (r.status === "‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤") dailyMap[key].buy += r.quantity;
      if (r.status === "‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å") dailyMap[key].sell += r.quantity;
    });

    const categories = Object.keys(dailyMap);
    const buySeries = categories.map(k => dailyMap[k].buy);
    const sellSeries = categories.map(k => dailyMap[k].sell);

    renderApexInventory(categories, buySeries, sellSeries, true);
  }

  function renderApexInventory(categories, buyData, sellData, isScrollable) {
    const allValues = [...buyData, ...sellData];
    let maxVal = Math.max(...allValues);
    maxVal = maxVal > 0 ? Math.ceil(maxVal / 100) * 100 : 100;

    // cleanup
    if (charts.y) charts.y.destroy();
    if (charts.main) charts.main.destroy();

    const scroller = document.getElementById("chart-scroller");
    let calculatedWidth = "100%";

    if (isScrollable) {
      const containerWidth = scroller.clientWidth || 800;
      const singleBarWidth = containerWidth / 6; // show ~6 days
      calculatedWidth = Math.max(containerWidth, categories.length * singleBarWidth);
    }

    // fixed y
    charts.y = new ApexCharts(document.querySelector("#chart-y"), {
      series: [{ name: "dummy", data: buyData }],
      chart: { type: "bar", height: "100%", width: "100%", fontFamily: "Prompt, sans-serif", toolbar:{show:false}, animations:{enabled:false} },
      colors: ["transparent"],
      plotOptions: { bar: { columnWidth: "0%" } },
      dataLabels: { enabled: false },
      grid: { show:false, padding:{ top:0, bottom:0, left:8 } },
      xaxis: { labels:{ show:true, style:{ colors:"transparent" }}, axisBorder:{show:false}, axisTicks:{show:false} },
      yaxis: {
        min:0, max:maxVal, tickAmount:5,
        labels: {
          formatter: (v)=> Number(v).toLocaleString(),
          style:{ fontSize:"15px", fontWeight:700, colors:"#64748b" },
          align:"right",
          offsetX: -10
        },
        axisBorder:{show:false},
        axisTicks:{show:false}
      }
    });
    charts.y.render();

    // main
    charts.main = new ApexCharts(document.querySelector("#chart-main"), {
      series: [
        { name: "‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤", data: buyData },
        { name: "‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å", data: sellData }
      ],
      chart: {
        type:"bar",
        height:"100%",
        width: calculatedWidth,
        fontFamily:"Prompt, sans-serif",
        toolbar:{show:false},
        animations:{enabled:false},
        stacked:false,
        zoom:{enabled:false}
      },
      colors: ["#22c55e", "#ef4444"],
      plotOptions: { bar: { borderRadius: 4, columnWidth:"80%" } },
      dataLabels: {
        enabled:true,
        style:{ fontSize:"12px", fontWeight:700, colors:["#000"] },
        formatter: (v)=> v > 0 ? Number(v).toLocaleString() : ""
      },
      legend: { show:true },
      xaxis: {
        categories,
        labels: {
          style:{ fontSize:"14px", fontWeight:700, colors:"#64748b" },
          formatter: (val)=>{
            if (!val) return "";
            if (typeof val === "string" && val.includes("-")) {
              const d = new Date(val);
              if (!isNaN(d.getTime())) return d.getDate();
            }
            return val;
          }
        },
        axisTicks:{show:false}
      },
      yaxis: { show:false, min:0, max:maxVal, tickAmount:5 },
      grid: { borderColor:"#cbd5e1", strokeDashArray:4, padding:{left:16,right:16,top:0,bottom:0} },
      tooltip: { enabled:false }
    });
    charts.main.render();

    if (isScrollable) scroller.scrollLeft = 0;
  }

  // =============================
  // Events
  // =============================
  document.getElementById("filter-year").addEventListener("change", () => { renderTable(); renderStats(); renderChart(); });
  document.getElementById("filter-month").addEventListener("change", () => { renderTable(); renderStats(); renderChart(); });
  document.getElementById("filter-status").addEventListener("change", () => { renderTable(); renderStats(); renderChart(); });

  // =============================
  // Init
  // =============================
  populateFilterOptions();
  fetchData();
</script>
</body>
</html>
