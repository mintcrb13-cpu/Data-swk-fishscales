// ====== IMPORTS (เหมือนเดิม) ======
import React, { useState, useEffect, useMemo } from 'react';
import {
  BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend,
  ResponsiveContainer, Brush
} from 'recharts';
import {
  Package, TrendingUp, TrendingDown, Calendar, FileText, Trash2, X,
  FlaskConical, History, BarChart3, AlertTriangle, LoaderCircle
} from 'lucide-react';

// ====== LoadingOverlay ======
const LoadingOverlay = ({ message }) => (
  <div className="fixed inset-0 bg-black bg-opacity-60 flex flex-col items-center justify-center z-50">
    <LoaderCircle className="w-16 h-16 text-white animate-spin mb-4" />
    <p className="text-white text-xl font-semibold">{message}</p>
  </div>
);

// ====== Alert Modal ======
const CustomAlertModal = ({
  title, message, onClose, onConfirm,
  showCancel = false, confirmText = 'ตกลง',
  cancelText = 'ยกเลิก',
  showPasswordInput = false,
  passwordValue, onPasswordChange, correctPassword
}) => {
  const [error, setError] = useState('');

  const confirm = () => {
    if (showPasswordInput && passwordValue !== correctPassword) {
      setError('รหัสผ่านไม่ถูกต้อง');
      onPasswordChange('');
      return;
    }
    onConfirm && onConfirm();
    onClose();
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-2xl p-8 w-full max-w-md relative">
        <button onClick={onClose} className="absolute top-3 right-3">
          <X />
        </button>

        <h3 className="text-2xl font-bold mb-4 text-center">{title}</h3>
        <p className="text-center mb-4 whitespace-pre-wrap">{message}</p>

        {showPasswordInput && (
          <>
            <input
              type="password"
              value={passwordValue}
              onChange={e => {
                setError('');
                onPasswordChange(e.target.value);
              }}
              className="w-full border p-3 rounded mb-2 text-center"
              placeholder="PASSWORD"
            />
            {error && <p className="text-red-500 text-center">{error}</p>}
          </>
        )}

        <div className="flex gap-3 mt-6">
          {showCancel && (
            <button onClick={onClose} className="flex-1 border rounded p-3">
              {cancelText}
            </button>
          )}
          <button onClick={confirm} className="flex-1 bg-blue-600 text-white rounded p-3">
            {confirmText}
          </button>
        </div>
      </div>
    </div>
  );
};

// ====== Tooltip ======
const CustomTooltip = ({ active, payload, label }) => {
  if (!active || !payload?.length) return null;
  return (
    <div className="bg-white border rounded p-3 shadow">
      <p className="font-bold">{label}</p>
      {payload.map((p, i) => (
        <p key={i} style={{ color: p.color }}>
          {p.name}: {p.value.toLocaleString()}
        </p>
      ))}
    </div>
  );
};

// =================== APP ===================
const App = () => {

  // ===== FIX 1: date parser guard =====
  const parseDate = (d) => {
    const date = new Date(d);
    return isNaN(date) ? null : date;
  };

  // ===== STATES =====
  const [records, setRecords] = useState([]);
  const [productionRecords, setProductionRecords] = useState([]);
  const [isLoading, setIsLoading] = useState(false);
  const [currentPage, setCurrentPage] = useState('inventory');

  const [showAlert, setShowAlert] = useState(false);
  const [alertConfig, setAlertConfig] = useState({});

  // ===== ALERT HELPERS =====
  const openAlert = (cfg) => {
    setAlertConfig(cfg);
    setShowAlert(true);
  };

  // ===== COMPUTED =====

  const getMonthlyTotalProduction = useMemo(() => {
    const now = new Date();
    return productionRecords.reduce((sum, r) => {
      const d = parseDate(r.timestamp);
      if (!d) return sum;
      if (d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear()) {
        return sum + r.bags;
      }
      return sum;
    }, 0);
  }, [productionRecords]);

  // ===== FIX 2: findLastIndex compatibility =====
  const safeLastIndex = (arr, fn) => {
    for (let i = arr.length - 1; i >= 0; i--) {
      if (fn(arr[i])) return i;
    }
    return -1;
  };

  // ===== RENDER =====
  if (currentPage === 'inventory') {
    return (
      <div className="min-h-screen p-8 bg-green-100">

        {isLoading && <LoadingOverlay message="กำลังโหลด..." />}
        {showAlert && <CustomAlertModal {...alertConfig} onClose={() => setShowAlert(false)} />}

        <h1 className="text-4xl font-bold text-center mb-8">
          ปริมาณสินค้า (เกล็ดปลาตากแห้ง)
        </h1>

        {/* FIX 3: function call */}
        <div className="bg-white p-6 rounded shadow text-center">
          <p className="text-xl mb-2">ผลิตเดือนนี้</p>
          <p className="text-5xl font-bold">
            {getMonthlyTotalProduction.toLocaleString()}
          </p>
          <p className="text-gray-500">กระสอบ</p>
        </div>

        <div className="mt-8 text-center">
          <button
            onClick={() => setCurrentPage('management')}
            className="bg-blue-600 text-white px-6 py-3 rounded"
          >
            ไปหน้ารายงานสถานะ
          </button>
        </div>
      </div>
    );
  }

  // ===== MANAGEMENT PAGE =====
  return (
    <div className="min-h-screen p-8 bg-blue-100">

      {showAlert && <CustomAlertModal {...alertConfig} onClose={() => setShowAlert(false)} />}

      <button
        onClick={() => setCurrentPage('inventory')}
        className="mb-6 underline"
      >
        ← กลับ
      </button>

      <h1 className="text-4xl font-bold text-center mb-8">
        รายงานสถานะสินค้า
      </h1>

      <ResponsiveContainer width="100%" height={300}>
        <BarChart data={records}>
          <CartesianGrid strokeDasharray="3 3" />
          <XAxis dataKey="name" />
          <YAxis />
          <Tooltip content={<CustomTooltip />} />
          <Legend />
          <Bar dataKey="quantity" fill="#4CAF50" />
        </BarChart>
      </ResponsiveContainer>
    </div>
  );
};

export default App;
